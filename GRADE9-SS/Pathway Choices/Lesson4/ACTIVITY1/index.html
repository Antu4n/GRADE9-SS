<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aisha’s Success Story</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ====== FONT IMPORTS ====== */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar{
            display: none;
        }
        /* ====== ROOT VARIABLES & SCALING ====== */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --border-radius: 1rem;
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: var(--header-font);
        }
        
        html {
             font-size: 1.8vmin;
        }

        /* ===== HIDE SCROLLBAR ===== */
        body::-webkit-scrollbar, .scenario-content::-webkit-scrollbar, .modal-content::-webkit-scrollbar { display: none; }
        body, .scenario-content, .modal-content { scrollbar-width: none; -ms-overflow-style: none; }

        /* ====== GLOBAL BASE ====== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #f0f4f8;
            font-family: var(--body-font);
            overflow: hidden;
        }
        #game-wrapper {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex; flex-direction: column; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        #game-container {
            width: 100%; height: 100%; background: #fff;
            position: relative; display: flex; flex-direction: column;
        }
        .screen {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }

        /* ===== START SCREEN ===== */
        #start-screen {
            color: var(--text-color-light); text-align: center; padding: 2rem;
            background-image: url('images/gamebg.jpg'); 
            background-size: cover; background-position: center;
        }
        #start-screen h1 {
            color: var(--text-color-light);
            font-size: 4rem;
            font-family: var(--header-font);
            font-weight: 500;
        }
        .start-button {
            font-family: var(--header-font);
            background: var(--secondary-color);
            color: var(--text-color-light);
            font-weight: 500;
            font-size: 1.2rem;
            border: 3px solid #fff;
            border-radius: 4.8rem;
            padding: 1rem 2.4rem;
            margin-top: 1.6rem;
            cursor: pointer;
            text-shadow: 0 0.2rem 0 #b88b2a;
            transition: all 0.2s;
        }
        .start-button:hover { transform: scale(1.06); }

        /* ===== GAME SCREEN ===== */
        #game-screen { 
            justify-content: flex-start; 
            overflow: hidden; 
            position: relative;
            background-color: #f4f1e9;
        }
        
        .game-top-section { 
            width: 100%; background-color: var(--primary-color); 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
            display: flex; justify-content: space-between; align-items: center;
            color: #fff; z-index: 20;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        #game-title {
            font-weight: 600;
            margin: 0; 
            font-family: var(--header-font);
        }
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        
        #progress-container { 
            width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
            border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
            border: 2px solid #fff; position: relative; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%; background: #FFFF00;
            border-radius: 0.8rem; transition: width 0.5s ease;
        }
        #progress-text { font-weight: 600; color: #fff; }

        .instructions-icon {
            width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease; animation: glow-pulse-white 3s infinite;
        }
        .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white;}

        .hint-icon {
            position: absolute; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem;
            background: var(--secondary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            z-index: 1001; border: 3px solid white; 
            transition: all 0.2s ease-out;
            animation: glow-pulse 2s infinite;
        }
        .hint-icon:hover { transform: scale(1.1); }
        .hint-icon svg { fill: white; width: 1.8rem; height: 1.8rem; }

        /* ===== STORYBOOK STYLE ===== */
        .scenario-title {
            font-family: var(--header-font); color: var(--text-color-dark);
            font-size: 2.2rem; text-align: center; padding: 1rem;
            width: 100%; flex-shrink: 0; font-weight: 600;
        }
        .scenario-content {
            flex: 1; padding: 1rem 2rem; overflow: hidden; display: flex;
            justify-content: center; align-items: center;
            perspective: 2500px;width: 100%;
        }
        .book-container {
            width: 95%; max-width: 90rem; height: 100%; display: flex;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4), inset 0 0 10px rgba(0,0,0,0.5);
            padding-bottom: 0.5rem;
        }
        .book-container::before {
            content: ''; position: absolute; top: 0; left: 50%;
            transform: translateX(-50%); width: 1.5rem; height: 100%;
            background-image: linear-gradient(to right, rgba(0,0,0,0.3), rgba(0,0,0,0) 30%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.3));
            z-index: 10;
        }
        .book-page {
            flex: 1; background: #FAF3E0; padding: 2rem;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 1.5rem;
            box-shadow: inset 5px 0 15px -5px rgba(0,0,0,0.2);
            position: relative; overflow: auto;
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }
        .book-page.left { border-right: 1px solid #ddd; justify-content: flex-start; }
        .scene-description { 
            font-size: 1.4rem; color: var(--text-color-dark); line-height: 1.7;
            text-align: left; width: 100%; font-family: var(--body-font);
        }
        #panel-image {
            width: 90%;
            height: 102%;
            border-radius: var(--border-radius);
            object-fit: fill;
        }
        #timeline-nav {
            display: flex; justify-content: flex-end; width: 100%;
            padding: 1.5rem 2rem; background: #f4f1e9; flex-shrink: 0;
        }
        .nav-btn {
            font-family: var(--header-font); background: var(--primary-color); color: #fff;
            font-weight: 500; font-size: 1.1rem; border: none;
            border-radius: 3rem; padding: 0.8rem 2.5rem; cursor: pointer;
            transition: all 0.2s; visibility: visible; margin-right: 4rem;
        }
        .nav-btn:hover:not(:disabled) { transform:none; }
        .nav-btn:disabled { background-color: #9e8a7e; cursor: not-allowed;  opacity: 0.7; }

        /* ===== 3D PAGE FLIP ANIMATION ===== */
        #page-turner {
            position: absolute; top: 0; left: 50%; width: 50%; height: 100%;
            transform-origin: left; transform-style: preserve-3d;
            display: none; z-index: 15; pointer-events: none;
        }
        #page-turner.turning-next { display: block; animation: turn-page-next 1s forwards ease-in-out; }
        #page-turner .page-content {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 1.5rem; overflow: hidden;
            background: #FAF3E0; padding: 2rem;
        }
        #page-turner .front { box-shadow: inset -8px 0 15px -5px rgba(0,0,0,0.3); }
        #page-turner .back { box-shadow: inset 8px 0 15px -5px rgba(0,0,0,0.3); transform: rotateY(180deg); }
        @keyframes turn-page-next { from { transform: rotateY(0deg); } to { transform: rotateY(-180deg); } }

        /* Keyword Highlighting */
        .keyword-hotspot {
            background-color: rgba(251, 176, 59, 0.25);
            padding: 2px 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            border-bottom: 2px solid var(--secondary-color);
        }
        .keyword-hotspot:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        .keyword-hotspot.viewed {
            background-color: rgba(92, 184, 92, 0.25);
            border-bottom-color: var(--correct-color);
            color: #333;
        }
         .keyword-hotspot.viewed:hover {
            background-color: var(--correct-color);
            color: white;
        }

        /* ===== MODAL STYLES (from Goal Explorer) ===== */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 3000; display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: #fff; padding: 2.5rem;
            border-radius: var(--border-radius); text-align: center;
            width: 90%; max-width: 600px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); } }
        .modal-content h2 {
            font-size: 2rem; font-weight: 600; margin-bottom: 1.5rem;
            color: var(--primary-color); font-family: var(--header-font);
        }
        .modal-content p, .modal-content ul { text-align: left; font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark); }
        .modal-btn {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 600;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            background-color: var(--primary-color); transition: transform 0.2s;
            margin-top: 1.5rem; font-family: var(--header-font);
        }
        .modal-btn:hover { transform: scale(1.02); }

        #activity-intro-overlay .modal-content, #instructions-modal-overlay .modal-content, #keyword-modal-overlay .modal-content { border-top: 8px solid var(--primary-color); }
         #keyword-modal-overlay .modal-content{
            height: 65vh;
            overflow-y: auto;
         }
        #hint-modal-overlay .modal-content { border-top: 8px solid var(--secondary-color); }
        
        #hint-modal-overlay h2 { color: var(--secondary-color); }
        #hint-modal-overlay .modal-btn { background-color: var(--secondary-color); }

        #keyword-popup-content p {
            background: #f3f3f363;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0rem;
            flex-direction: column;
        }
        #keyword-popup-content p strong {
            font-size: 1.5rem;
        }
        #intro-text p{
            background: #f8f9fa; padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--primary-color); text-align: center; font-size: 1.3rem;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        }
        .completion-title-banner { 
             font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 500; color: white;
        }
        #completion-overlay .modal {
      background: transparent; box-shadow: none; width: auto; max-width: none;
      display: flex; justify-content: center; align-items: center;
      padding: 0; overflow: visible;
    }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid #FBB03B; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin: 1.5rem 0;
        }
         .completion-buttons {
            position: static; width: 100%; display: flex; justify-content: space-between;
            gap: 1rem; padding: 0 2rem 2rem 2rem; box-sizing: border-box;
            align-items: flex-end; margin-top: 0;
         }
        .completion-btn {
            font-family: var(--header-font); background: var(--secondary-color); color: #fff;
            font-weight: 500; 
            font-size: 1.3rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none;
            min-width: 8.75rem; /* 140px */
        }
        .completion-btn:hover { transform: scale(1.05); }
          @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(255,255,255,0.5); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 30px rgba(255,255,255,0.7); transform: scale(1.1); }
            }
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(251,176,59,0.5), 0 0 20px rgba(251,176,59,0.3); } 50% { box-shadow: 0 0 20px rgba(251,176,59,0.8), 0 0 30px rgba(251,176,59,0.5); transform: scale(1.1); } }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 991px) { 
            #game-wrapper { width: 100vw !important; height: 100vh !important; border-radius: 0 !important; max-width: none !important; aspect-ratio: unset !important; box-shadow: none; }
            html { font-size: 2.9vmin; }
            #page-turner { display: none !important; }
            .book-container {
                height: auto;
                width: 100%;
                box-shadow: none;
                max-height: 100%;
            }   
             .book-container::before { display: none; }
            .book-page.left { border-right: none; border-bottom: 2px solid #ddd; padding-bottom: 1.5rem; }
            .book-page.right { flex-shrink: 0; padding-top: 1rem; }
            #panel-image { max-height: 65vh; }
            #timeline-nav { justify-content: center; padding: 0.5rem; }
            .scenario-content { padding: 1rem; overflow-y: auto; }
             #keyword-modal-overlay .modal-content{
                height: 90vh;
                overflow-y: auto;
             }
             .start-button{
                font-size: 1.3rem;
             }
             .nav-btn:disabled{
                transform: none;
             }
             .nav-btn{
                margin-right: 0;
             }
            #completion-image{
            width: 57%;
            }

        }
        @media (max-width: 768px) {
            html { font-size: 3.3vmin; }
            .scenario-title { font-size: 1.8rem; }
            .book-page { padding: 1rem; }
            .scene-description{ font-size: 1.2rem; }
            #completion-image{
                width: 64%;
            }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Aisha’s Success Story</h1>
            <button class="start-button" onclick="showGameScreen();">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
                <h1 id="game-title">Aisha's Journey</h1>
                <div class="top-right-controls">
                    <div id="progress-container"><div id="progress-bar"></div></div>
                    <span id="progress-text">0 / 2</span>
                    <div class="instructions-icon" onclick="showInstructions()">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
            </div>
            
            <div class="scenario-content" id="comic-view">
                <div class="book-container" id="book-container">
                    <div class="book-page left" id="left-page">
                        <p class="scene-description" id="scene-description-text"></p>
                    </div>
                    <div class="book-page right" id="right-page">
                        <img id="panel-image" src="" alt="Panel Image">
                    </div>
                    <div id="page-turner">
                        <div class="page-content front" id="page-turner-front"></div>
                        <div class="page-content back" id="page-turner-back"></div>
                    </div>
                </div>
            </div>
            
            <div id="timeline-nav">
                <button id="next-page-btn" class="nav-btn" onclick="goToNextPage()">Next</button>
            </div>
            
            <div class="hint-icon" id="hint-icon" onclick="showHint()">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
            </div>
        </div>

        <div id="completion-overlay" class="modal-overlay hidden">
            <div>
                <h2 class="completion-title-banner" id="completion-title">Activity Conclusion</h2>
                  <div class="modal">
                <img id="completion-image" src="images/complete.jpg" alt="Completion celebration" onerror="this.src='https://placehold.co/400x300/7c3aed/ffffff?text=Complete!'; this.onerror=null;">
            </div>
                <div class="completion-buttons">
                    <button class="completion-btn" onclick="restartGame()">Restart Activity</button>
                    <button class="completion-btn" onclick="goToNextActivity()">Next Activity</button>
                </div>
            </div>
        </div>

        <div id="activity-intro-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Activity Introduction</h2>
                <div id="intro-text"></div>
                <button class="modal-btn" onclick="closeModal('activity-intro-overlay')">Continue</button>
            </div>
        </div>
        <div id="instructions-modal-overlay" class="modal-overlay hidden">
             <div class="modal-content">
                <h2>Learner Instructions</h2>
                <div id="instructions-text"></div>
                <button class="modal-btn" onclick="closeModal('instructions-modal-overlay')">Got it!</button>
            </div>
        </div>
        <div id="hint-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Here's a hint...</h2>
                <ul id="hint-list" style="list-style: none; padding: 0;"></ul>
                <button class="modal-btn" onclick="closeModal('hint-modal-overlay')">Got it!</button>
            </div>
        </div>
        
        <div id="keyword-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 id="keyword-popup-title"></h2>
                <div id="keyword-popup-content"></div>
                <button class="modal-btn" id="keyword-modal-close-btn">Continue</button>
            </div>
        </div>
    </div>
</div>

<script>
    const activityData = {
        introduction: `<p>Meet Aisha, a confident, successful businesswoman who turned her school pathway into a thriving career!  As you read her story, click on the highlighted keywords to explore how her decisions in school helped shape her skills and achievements. Ready to find out how a pathway can pave the way? Let us click into her journey!</p>`,
        instructions: `<p><strong>Step 1 – Read Aisha’s Story:</strong> Carefully read through the story. Look out for highlighted keywords; these are clues to important skills, subjects, and choices in her journey.</p><p><strong>Step 2 – Click the Keywords:</strong> Whenever you see a glowing or pulsing keyword, click on it to reveal the skill or subject explained, how it helped Aisha succeed, and the subject or track it came from.</p><p><strong>Step 3 – Make Connections:</strong> As you explore each keyword, think about how the subject or skill connects to Aisha’s career and how similar choices might help you in your own future.</p>`,
        hints: [
            "Click on the glowing words in the story to learn more about Aisha's skills.",
            "Pay attention to how different school subjects helped Aisha in her business.",
            "Think about how the skills Aisha learned can be useful in other careers too."
        ],
    conclusion: "Activity Conclusion",
        pages: [
            {
                image: "images/page1.jpg",
                text: "Aisha always enjoyed working with people. In junior school, she loved class discussions and organizing group projects. When she joined senior school, she chose the ##Humanities and Business Studies## track in the Social Sciences pathway because she wanted to understand how people think and how businesses work. In her Business Studies lessons, Aisha learnt how to ##handle money##, keep records, and write business plans. She also studied Languages and Literature, which helped her ##communicate effectively## with customers and write clear adverts for her products.",
                keywords: ["Humanities and Business Studies", "handle money", "communicate effectively"]
            },
            {
                image: "images/page 2.jpg",
                text: "One of her Favorite lessons was ICT. She became ##competent in ICT skills## and used that knowledge to create posters, send emails, and even design a basic website for her shop. After school, she started a small business selling handmade bags and earrings. To grow her brand, she learnt how to ##advertise online##, using platforms like WhatsApp and Instagram. Today, Aisha is a successful entrepreneur. She manages her own shop, handles orders, trains other young women, and even gives talks at youth empowerment events. She always says, “Choosing the right pathway gave me direction, purpose, and the skills I needed to succeed.”",
                keywords: ["competent in ICT skills", "advertise online"]
            }
        ],
        keywords: {
            "Humanities and Business Studies": {
                title: "Humanities and Business Studies",
                explanation: "Focuses on understanding people, society, and how businesses operate, including decision-making, ethics, and customer relations.",
                howItHelped: "This track taught Aisha how to manage businesses, understand customers, and make ethical decisions. It set the foundation for her success.",
                track: "Humanities & Business Studies – Social Sciences Pathway"
            },
            "handle money": {
                title: "Handling Money",
                explanation: "Teaches financial literacy, including budgeting, record-keeping, and profit management.",
                howItHelped: "Aisha learnt financial literacy through Business Studies. Now, she confidently manages profits and budgeting.",
                track: "Business Studies – Humanities & Business Studies Track (Social Sciences Pathway)"
            },
            "communicate effectively": {
                title: "Effective Communication",
                explanation: "Develops clear speaking and writing skills for everyday interactions and professional contexts.",
                howItHelped: "In Languages and Literature, she practiced clear writing and speaking, skills she uses every day to talk to clients and suppliers.",
                track: "Languages & Literature – Social Sciences Pathway"
            },
            "competent in ICT skills": {
                title: "ICT Competence",
                explanation: "Covers the use of computers and digital tools for communication, marketing, and record-keeping.",
                howItHelped: "Her ICT lessons helped her create digital adverts, manage online orders, and even build a website for her business!",
                track: "ICT – Applied Sciences (STEM Pathway)"
            },
            "advertise online": {
                title: "Online Advertising",
                explanation: "Combines digital marketing techniques with an understanding of customer needs and online platforms.",
                howItHelped: "Thanks to her ICT and Business lessons, Aisha knows how to reach customers through social media and digital platforms.",
                track: "ICT & Business Studies – Cross between Applied Sciences (STEM) and Humanities & Business Studies (Social Sciences)"
            }
        }
    };

    let currentPageIndex = 0;
    const totalPages = activityData.pages.length;
    let introAudio, dingAudio, outroAudio, pageTurnAudio;
    let isTurningPage = false;
    let typewriterInterval;
    let viewedKeywords = new Set();

    function initAudio() {
        try {
            introAudio = new Audio('audio/intro.mp3');
            dingAudio = new Audio('audio/ding.mp3');
            outroAudio = new Audio('audio/outro.mp3');
            pageTurnAudio = new Audio('audio/page-flip.mp3');
        } catch (e) {
            console.warn("Audio could not be loaded.");
            const mockAudio = { play: () => {}, pause: () => {}, currentTime: 0 };
            introAudio = dingAudio = outroAudio = pageTurnAudio = mockAudio;
        }
    }

    function playSound(audio) { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); } }
    function stopSound(audio) { if(audio) { audio.pause(); } }

    function initGame() {
        currentPageIndex = 0;
        loadPage(currentPageIndex);
    }
    
    function typewriter(element, text, callback) {
        let i = 0;
        element.innerHTML = "";
        clearInterval(typewriterInterval);
        typewriterInterval = setInterval(() => {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
            } else {
                clearInterval(typewriterInterval);
                if (callback) callback();
            }
        }, 20); 
    }

    function highlightKeywords() {
        const textContainer = document.getElementById('scene-description-text');
        let html = textContainer.innerHTML;

        // Replace plain keyword occurrences (the text is sanitized before typing to remove '##')
        activityData.pages[currentPageIndex].keywords.forEach(keyword => {
            const regex = new RegExp(escapeRegExp(keyword), 'g');
            html = html.replace(regex, `<span class="keyword-hotspot" data-keyword="${keyword}">${keyword}</span>`);
        });

        textContainer.innerHTML = html;

        document.querySelectorAll('.keyword-hotspot').forEach(span => {
            span.addEventListener('click', () => {
                showKeywordPopup(span.dataset.keyword);
                span.classList.add('viewed');
            });
        });
    }

    function loadPage(index, isInstant = true) {
        viewedKeywords.clear();
        currentPageIndex = index;
        const page = activityData.pages[index];
        
        const leftPage = document.getElementById('left-page');
        const rightPage = document.getElementById('right-page');
        const descText = document.getElementById('scene-description-text');
        const panelImage = document.getElementById('panel-image');

        if (!isInstant) {
            leftPage.style.opacity = 0;
            rightPage.style.opacity = 0;
        }
        
        setTimeout(() => {
            panelImage.src = page.image;
            panelImage.alt = `Illustration for page ${index + 1}`;
            
            // Remove the marker delimiters (##) before typing so they never appear during the typewriter effect
            const sanitizedText = page.text.replace(/##(.*?)##/g, '$1');
            const textToType = sanitizedText;
            typewriter(descText, textToType, highlightKeywords);
            
            if (!isInstant) {
                leftPage.style.opacity = 1;
                rightPage.style.opacity = 1;
            }
        }, isInstant ? 0 : 300);

        updateProgress();
        updateNavButtons();
    }
    
    function showKeywordPopup(keyword) {
        const data = activityData.keywords[keyword];
        if (!data) return;

        playSound(dingAudio);
        document.getElementById('keyword-popup-title').textContent = data.title;
        document.getElementById('keyword-popup-content').innerHTML = `
            <p><strong>Skill/Subject:</strong> ${data.explanation}</p>
            <p><strong>How it Helped Aisha:</strong> ${data.howItHelped}</p>
            <p><strong>Subject/Track:</strong> ${data.track}</p>
        `;
        document.getElementById('keyword-modal-overlay').classList.remove('hidden');

        document.getElementById('keyword-modal-close-btn').onclick = () => {
            closeModal('keyword-modal-overlay');
            viewedKeywords.add(keyword);
            checkAllKeywordsViewed();
        };
    }

    function checkAllKeywordsViewed() {
        const totalKeywordsOnPage = activityData.pages[currentPageIndex].keywords.length;
        if (viewedKeywords.size === totalKeywordsOnPage) {
            document.getElementById('next-page-btn').disabled = false;
        }
    }

    function goToNextPage() {
        if (isTurningPage) return;
        
        if (currentPageIndex >= totalPages - 1) {
            endActivity();
            return;
        }
        
        if (window.innerWidth <= 991) {
             loadPage(currentPageIndex + 1, false);
             return;
        }

        isTurningPage = true;
        document.getElementById('next-page-btn').disabled = true;
        const pageTurner = document.getElementById('page-turner');
        const pageTurnerFront = document.getElementById('page-turner-front');
        const pageTurnerBack = document.getElementById('page-turner-back');
        
        const currentPage = activityData.pages[currentPageIndex];
        const nextPage = activityData.pages[currentPageIndex + 1];

        pageTurnerFront.innerHTML = `<img src="${currentPage.image}" alt="Page ${currentPageIndex + 1}" style="width: 100%; height: 100%; object-fit: contain; border-radius: var(--border-radius);">`;
        
        // Prepare back page text without the marker delimiters and replace keywords with hotspots
        let backText = nextPage.text.replace(/##(.*?)##/g, '$1');
        nextPage.keywords.forEach(kw => {
            const regex = new RegExp(escapeRegExp(kw), 'g');
            backText = backText.replace(regex, `<span class="keyword-hotspot" data-keyword="${kw}">${kw}</span>`);
        });
        pageTurnerBack.innerHTML = `<p class="scene-description">${backText}</p>`;
        
        playSound(pageTurnAudio);
        pageTurner.classList.add('turning-next');

        pageTurner.onanimationend = () => {
            const newIndex = currentPageIndex + 1;
            loadPage(newIndex, true); 
            
            pageTurner.classList.remove('turning-next');
            pageTurner.onanimationend = null;
            isTurningPage = false;
        };
    }

    function updateNavButtons() {
        const nextBtn = document.getElementById('next-page-btn');
        nextBtn.disabled = true; // Always disable on new page load
        nextBtn.textContent = (currentPageIndex === totalPages - 1) ? 'Finish' : 'Next';
    }
    
    function updateProgress() {
        document.getElementById('progress-bar').style.width = `${((currentPageIndex + 1) / totalPages) * 100}%`;
        document.getElementById('progress-text').textContent = `${currentPageIndex + 1} / ${totalPages}`;
    }
    
    function showGameScreen() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        showActivityIntro();
    }
    
    function showActivityIntro() {
        document.getElementById('activity-intro-overlay').classList.remove('hidden');
        playSound(introAudio);
        sendEvent('ActivityEvent.START_ACTIVITY', {activityName: 'Aisha’s Success Story'});
    }

    function showInstructions() { document.getElementById('instructions-modal-overlay').classList.remove('hidden'); }
    function showHint() { document.getElementById('hint-modal-overlay').classList.remove('hidden'); }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'activity-intro-overlay') { 
            stopSound(introAudio); 
            initGame(); 
        }
    }
    
    function endActivity() {
        document.getElementById('completion-title').innerHTML = activityData.conclusion;
        document.getElementById('completion-overlay').classList.remove('hidden');
        playSound(outroAudio);
    }
    
    function restartGame() {
        stopSound(outroAudio);
        document.getElementById('completion-overlay').classList.add('hidden');
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        initGame();
    }

    function goToNextActivity() { 
        window.location.href = "../ACTIVITY2/index.html";
        stopSound(outroAudio);
        sendEvent('ActivityEvent.END_ACTIVITY', {activityName: 'Aisha’s Success Story'});

    }
    
    function populateStaticContent() {
        document.getElementById('intro-text').innerHTML = activityData.introduction;
        document.getElementById('instructions-text').innerHTML = activityData.instructions;
        
        const hintList = document.getElementById('hint-list');
        hintList.innerHTML = activityData.hints.map(item => `<li>${item}</li>`).join('');

        document.getElementById('progress-text').textContent = `1 / ${totalPages}`;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        initAudio();
        populateStaticContent();
    });

    // Helper to escape regex special characters in keyword strings
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
    }
    
</script>
<script src = "../eventSender.js"></script>
</body>
</html>