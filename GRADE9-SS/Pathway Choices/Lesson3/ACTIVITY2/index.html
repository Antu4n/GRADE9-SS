<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Find Your Fit!</title>
<style>
    /* Font Imports and Keyframes */
    @font-face {
        font-family: 'Fredoka';
        src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    @keyframes pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(251, 176, 59, 0.3); }
        50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(251, 176, 59, 0.6); }
    }
    @keyframes glow-pulse-white {
        0%, 100% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5); transform: scale(1); }
        50% { box-shadow: 0 0 20px rgba(255, 255, 255, 1), 0 0 30px rgba(255, 255, 255, 0.7); transform: scale(1.05); }
    }
    @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(251,176,59,0.5), 0 0 20px rgba(251,176,59,0.3); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(251,176,59,0.8), 0 0 30px rgba(251,176,59,0.5); transform: scale(1.1); } }
    
    ::-webkit-scrollbar{ display: none; }

    /* Root Variables */
    :root {
        --primary-color: #5D04B2;
        --secondary-color: #fbb03b;
        --text-color-dark: #333;
        --text-color-light: #fff;
        --card-background-light: #ffffff;
        --shadow-dark: rgba(0, 0, 0, 0.3);
        --border-radius: 1.5rem;
        --header-font: 'Fredoka', sans-serif;
        --path-arts: #f39c12;
        --path-stem: #3498db;
        --path-social: #8e44ad;
        --path-mixed: #1abc9c;
    }

    /* Global Reset & Base Styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { width: 100%; height: 100vh; overflow: hidden; }
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f4f8;
        font-family: var(--header-font), sans-serif;
    }
    #game-wrapper {
        width: 100%;
        max-width: 1200px;
        aspect-ratio: 16 / 9;
        box-shadow: 0 15px 40px var(--shadow-dark);
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
        background: #f8f9ff;
    }
    #game-container {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .screen {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        transition: opacity 0.5s ease-in-out;
        overflow: hidden;
    }
    .screen.hidden { opacity: 0; pointer-events: none; }
    
    #start-screen {
       background-image: url('images/gamebg.jpg');
       background-size: cover;
       background-position: center;
       justify-content: center;
       align-items: center;
       padding: 2rem;
       text-align: center;
    }
    #start-screen h1 {
      color: var(--text-color-light);
      font-size: 4rem;
      font-family: var(--header-font);
      font-weight: 500;
    }
    .start-button {
        font-family: var(--header-font);
        background: var(--secondary-color);
        color: var(--text-color-light);
        font-weight: 500;
        font-size: 1.2rem;
        border: 3px solid #fff;
        border-radius: 4.8rem;
        padding: 1rem 2.4rem;
        margin-top: 1.6rem;
        cursor: pointer;
        text-shadow: 0 0.2rem 0 #b88b2a;
        transition: all 0.2s;
    }
    .start-button:hover { transform: scale(1.06); }
    #game-screen { background: #f8f9ff; justify-content: flex-start; }

    .game-top-section {
        width: 100%; flex-shrink: 0; display: flex; justify-content: space-between;
        align-items: center; background-color: var(--primary-color); z-index: 10;
        color: var(--text-color-light); padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); gap: 1rem;
    }
    #game-title {
        font-size: clamp(1.2rem, 4vmin, 1.8rem); font-weight: 600;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3); flex: 1 1 300px; min-width: 0;
    }
    .top-right-controls { display: flex; align-items: center; gap: 1rem; }
    #progress-container {
        width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
        border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
        border: 2px solid #fff; position: relative; overflow: hidden;
    }
    #progress-bar {
        height: 100%; width: 0%; background: #FFFF00;
        border-radius: 0.8rem; transition: width 0.5s ease;
    }
    #progress-text {
        color: var(--text-color-light); font-weight: 600;
        font-size: clamp(0.75rem, 2vmin, 1rem); text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
    }
    .instructions-icon {
        width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex;
        align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
        z-index: 15; flex-shrink: 0;
        animation: glow-pulse-white 2s infinite;
    }
    .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
    .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white;}

    .game-content {
        flex: 1; display: flex; overflow: hidden; position: relative;
        align-items: center; justify-content: center;
    }

    /* --- Decision Tree Styles --- */
    #decision-tree-container {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        transition: opacity 0.5s ease-in-out;
    }
    #decision-tree-svg {
        width: 100%; height: 100%;
    }
    .connector-line {
        stroke-width: 4px;
        fill: none;
        stroke-dasharray: 1000;
        stroke-dashoffset: 1000;
        animation: draw-line 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        filter: drop-shadow(0 0 5px rgba(0,0,0,0.2));
    }
    @keyframes draw-line { to { stroke-dashoffset: 0; } }
    
    .node {
        position: absolute;
        text-align: center;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .node.visible { opacity: 1; transform: scale(1); }
    .node.faded { opacity: 0.3; }
    .node.hiding { opacity: 0; transform: scale(0.8); }

    .root-node {
        padding: 1.5rem 2.5rem;
        border-radius: var(--border-radius);
        color: white;
        font-size: clamp(1.2rem, 3vmin, 1.8rem);
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: pulse 2.5s infinite ease-in-out;
    }
    
    .leaf-node {
        padding: 1rem 1.5rem;
        border-radius: 50px;
        color: white;
        font-size: clamp(0.9rem, 2.5vmin, 1.1rem);
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        border: 2px solid rgba(255,255,255,0.5);
    }
    .leaf-node:hover { transform: scale(1.05) !important; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
    .leaf-node.selected {
        animation: pulse 0.5s once;
        box-shadow: 0 0 20px 5px currentColor;
    }
    
    /* Leaf node color themes */
    .leaf-node[data-theme="arts"] { background: linear-gradient(135deg, #f39c12, #e67e22); }
    .leaf-node[data-theme="stem"] { background: linear-gradient(135deg, #3498db, #2980b9); }
    .leaf-node[data-theme="social"] { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
    .leaf-node[data-theme="mixed"] { background: linear-gradient(135deg, #1abc9c, #16a085); }
    
    /* Connector line color themes */
    .connector-line[data-theme="arts"] { stroke: url(#grad-arts); }
    .connector-line[data-theme="stem"] { stroke: url(#grad-stem); }
    .connector-line[data-theme="social"] { stroke: url(#grad-social); }
    .connector-line[data-theme="mixed"] { stroke: url(#grad-mixed); }

    /* Modal Styles */
    .modal-overlay, .overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
        z-index: 1000; display: flex; justify-content: center; align-items: center;
        animation: fadeIn 0.3s ease;
    }
    .modal-overlay.hidden, .overlay.hidden { display: none; }
    .modal-content, .modal {
        background: var(--card-background-light); padding: 2.5rem;
        border-radius: var(--border-radius); text-align: center;
        width: 90%; max-width: 600px;
        animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
    }
    .modal-content h2, .modal h2 {
      font-size: 2rem; font-weight: 600; margin-bottom: 1.5rem;
      color: var(--primary-color);
    }
    .modal-content p, .modal p { font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark); }
     .modal ul {
        list-style-position: inside; text-align: left; margin-top: 1rem; padding-left: 1rem;
    }
    .modal li { margin-bottom: 0.8rem; font-size: 1.1em; line-height: 1.5; }
    .modal-btn, .modal button {
        width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700;
        border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
        background-color: var(--primary-color); transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 1.5rem;
        font-family: var(--header-font);
    }
    .modal-btn:hover, .modal button:hover { transform: scale(1.02); }
    #activity-intro-overlay .modal-content, #instructions-modal-overlay .modal-content { border-top: 8px solid var(--primary-color); }
    #activity-intro-overlay .modal-content p {
        text-align: left; background: #f8f9fa; padding: 1.5rem;
        border-radius: 0.75rem; border-left: 4px solid var(--primary-color);
        line-height: 1.5; font-size: 1.2rem; color: var(--text-color-dark);
    }
    #instructions-modal-overlay .modal-content ul{
        text-align: left;
        padding-left: 1.5rem;
        font-size: 1.1rem;
        list-style-type: disc;
    }
    
    /* Hint Overlay Styling */
    #hint-overlay .modal { 
        max-width: 500px; 
        border-top: 8px solid var(--secondary-color);
;
    }
    #hint-overlay .modal h2 {
        color: var(--secondary-color);
    }
    #hint-overlay .modal button {
        background-color: var(--secondary-color);
        
    }

    /* Result Overlay Styles */
    .result-node {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: clamp(1.5rem, 4vw, 3rem);
        max-width: 700px;
        width: 95%;
        border-radius: var(--border-radius);
        text-align: center;
        border-top: 10px solid var(--secondary-color);
        box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #result-overlay h2 {
        font-size: clamp(1.2rem, 3.5vmin, 1.8rem);
        font-weight: 500; color: var(--primary-color); text-transform: uppercase;
        letter-spacing: 1px;
    }
    #result-pathway-track {
        font-size: clamp(2rem, 6vmin, 3rem);
        font-weight: 600;
        color: var(--primary-color);
        margin: 0.5rem 0 1.5rem 0;
    }
    #result-feedback {
        font-size: clamp(1rem, 2.5vmin, 1.2rem);
        margin-bottom: 2rem; color: var(--text-color-dark);
        line-height: 1.6;
    }
    #result-careers h3 {
        font-size: clamp(1.1rem, 3vmin, 1.5rem);
        font-weight: 600; color: var(--text-color-dark);
        margin-bottom: 1rem;
    }
    .careers-list {
        display: flex; flex-wrap: wrap; justify-content: center;
        gap: 0.75rem; padding: 0; list-style: none;
    }
    .careers-list li {
        background-color: #e9d8f9;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 0.5rem 1.5rem;
        border-radius: 2rem;
        font-size: clamp(0.9rem, 2.5vmin, 1.1rem);
        font-weight: 500;
    }

    .result-buttons {
        margin-top: 2rem;
        width: 100%; display: flex;
        justify-content: center; gap: 1.5rem; flex-wrap: wrap;
    }
    .result-btn {
        font-family: var(--header-font); background: var(--secondary-color); color: #fff;
        font-weight: 500; font-size: clamp(1rem, 2.5vmin, 1.3rem); border: 0.1875rem solid #fff; border-radius: 3rem; 
        padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
        cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
        text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none; min-width: 8.75rem;
    }
    .result-btn:hover { transform: scale(1.1) translateY(-3px); }
    .result-btn.continue-btn { background: var(--primary-color); text-shadow: none; }

    /* Hint Icon */
    .hint-icon {
        position: absolute; bottom: 1.5rem; right: 1.5rem; width: 3.125rem; height: 3.125rem;
        background: var(--secondary-color); border-radius: 50%; display: flex;
        align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
        z-index: 20;
        border: 0.1875rem solid white;
        animation: glow-pulse 2s infinite;
    }
    .hint-icon:hover { transform: scale(1.1); }
    .hint-icon svg { fill: white; width: 1.5rem; height: 1.5rem; }

    /* ===== COMPLETION SCREEN ===== */
    #completion-overlay { 
        background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        color: #fff; flex-direction: column; justify-content: center;
        align-items: center; gap: 1rem; padding: 1rem;
    }
    .completion-title-banner { 
        font-size: clamp(2rem, 7vmin, 4rem);
        text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
        text-align: center; font-family: var(--header-font);
        font-weight: 500;
    }
    #completion-overlay .modal { 
        background: transparent; box-shadow: none; width: auto; max-width: none;
        display: flex; justify-content: center; align-items: center;
        padding: 0; overflow: visible;
    }
    #completion-image { 
        width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
        border: 3px solid #FBB03B; border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        margin-top: 0.5rem;
        margin-bottom: 3rem;
    }
    .completion-buttons {
        position: absolute; bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        gap: 1.5rem;
        width: 100%;
        padding: 1rem 2rem;
    }
    .completion-btn {
        font-family: var(--header-font); background: var(--secondary-color); color: #fff;
        font-weight: 500; 
        font-size: 1.3rem;
        border: 0.1875rem solid #fff; border-radius: 3rem; 
        padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
        cursor: pointer; transition: all 0.2s;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
        text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none;
        min-width: 8.75rem; /* 140px */
    }
    .completion-btn:hover { 
        transform: scale(1.05); 
        box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2);
    }
    
    .visually-hidden {
        position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0;
        overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
    }

    @media (max-width: 1024px) {
        #game-wrapper { 
            width: 100vw; height: 100vh;
            border-radius: 0; aspect-ratio: unset; 
        }
        .leaf-node { padding: 0.8rem 1.2rem; }
        .root-node { padding: 1.2rem 2rem; }
    }
    @media (max-width:991px){
          #activity-intro-overlay .modal-content{
            border-top: 8px solid var(--primary-color);
            height: 99vh;
            overflow: auto;
        }
        #hint-overlay .modal{
            height: 95vh;
            overflow-y: auto;
        }
        #hint-overlay .modal button {
            margin-top: 0rem;
        }
        #completion-image { max-width: 50%; }
         .completion-buttons{
            bottom: 0rem;
        }
        .result-node{
            height: 99vh;
            overflow-y: auto;
        }

    }
    @media(max-width:768px){
        .leaf-node[data-theme="arts"]{
            margin-left: 1.5rem;
        }
        #completion-image { max-width: 66%; }
        .completion-btn { min-width: 155px; font-size: 1rem;}
       
      
    }
</style>
</head>
<body>
<div id="game-wrapper">
   <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Find Your Fit!</h1>
            <button class="start-button">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
               <h1 id="game-title">Find Your Fit!</h1>
               <div class="top-right-controls">
                   <div id="progress-container"><div id="progress-bar"></div></div>
                   <div id="progress-text">1 / 3</div>
                   <div class="instructions-icon" id="instructions-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                   </div>
               </div>
            </div>
            <div class="game-content">
                <div id="decision-tree-container"></div>
                 <svg id="decision-tree-svg" style="position:absolute; top:0; left:0; pointer-events:none;">
                    <defs>
                        <linearGradient id="grad-arts" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#f39c12;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#e67e22;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-stem" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#3498db;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2980b9;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="grad-social" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#9b59b6;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8e44ad;stop-opacity:1" />
                        </linearGradient>
                         <linearGradient id="grad-mixed" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#1abc9c;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#16a085;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="hint-icon" id="hint-icon">
                    <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
                </div>
            </div>
        </div>

        <div id="activity-intro-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Activity Introduction</h2>
                <p>Let us find your fit! This decision tree will help you explore your passions and strengths, and guide you to a track that suits your future goals. Just click your way through a few simple choices. Ready to discover your match? Let us go!</p>
                <button class="modal-btn" id="intro-continue-btn">Continue</button>
            </div>
        </div>

        <div id="instructions-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Learner Instructions</h2>
                <ul>
                    <li><b>Start:</b> Read each question that appears in the center.</li>
                    <li><b>Choose:</b> Click the option that best matches your interests.</li>
                    <li><b>Follow:</b> Your choice will reveal the next step on your path.</li>
                    <li><b>Discover:</b> At the end, you'll see your recommended career track.</li>
                </ul>
                <button class="modal-btn" id="close-instructions-btn">Got It!</button>
            </div>
        </div>

        <div id="hint-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Here's a hint...</h2>
                <p>Your interests might cross into multiple fields, and that's a strength! Consider how you can blend your talents in unique ways.</p>
                <ul id="hint-list"></ul>
                <button id="close-hint-btn">Got it!</button>
            </div>
        </div>

        <div id="result-overlay" class="modal-overlay hidden">
            <div class="result-node">
                <h2>Your Recommended Fit:</h2>
                <h1 id="result-pathway-track">Pathway & Track</h1>
                <p id="result-feedback">Feedback on why this is a good fit for you.</p>
                <div id="result-careers">
                    <h3>ðŸ’¼ Sample Careers You Might Enjoy:</h3>
                    <ul class="careers-list"></ul>
                </div>
                <div class="result-buttons">
                    <button class="result-btn continue-btn">Continue</button>
                </div>
            </div>
        </div>

        <div id="completion-overlay" class="overlay hidden">
            <h2 class="completion-title-banner">Activity Conclusion</h2>
            <img id="completion-image" src="images/complete.jpg" alt="Activity Complete Summary">
            <div class="completion-buttons">
                <button class="completion-btn btn-previous">Previous Activity</button>
                <button class="completion-btn btn-restart">Restart Activity</button>
                <button class="completion-btn btn-next">Next Activity</button>
            </div>
        </div>
        
        <div id="aria-live-announcer" class="visually-hidden" aria-live="polite"></div>
        
    <audio id="ding-sound" src="audio/ding.mp3" preload="auto"></audio>
    <audio id="intro-sound" src="audio/intro.mp3" preload="auto"></audio>
    <audio id="outro-sound" src="audio/outro.mp3" preload="auto"></audio>
   </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const startScreen = document.getElementById('start-screen'), gameScreen = document.getElementById('game-screen');
    const startBtn = document.querySelector('.start-button');
    const treeContainer = document.getElementById('decision-tree-container');
    const svgCanvas = document.getElementById('decision-tree-svg');
    const announcer = document.getElementById('aria-live-announcer');
    const progressBar = document.getElementById('progress-bar'), progressText = document.getElementById('progress-text');
    const activityIntroOverlay = document.getElementById('activity-intro-overlay'), introContinueBtn = document.getElementById('intro-continue-btn');
    const instructionsIcon = document.getElementById('instructions-icon'), instructionsModalOverlay = document.getElementById('instructions-modal-overlay'), closeInstructionsBtn = document.getElementById('close-instructions-btn');
    const resultOverlay = document.getElementById('result-overlay'), hintOverlay = document.getElementById('hint-overlay'), completionOverlay = document.getElementById('completion-overlay');
    const hintIcon = document.getElementById('hint-icon'), hintList = document.getElementById('hint-list'), closeHintBtn = document.getElementById('close-hint-btn');
    const dingSound = document.getElementById('ding-sound'), introSound = document.getElementById('intro-sound'), outroSound = document.getElementById('outro-sound');

    // Game State
    let isPaused = true, currentStep = 0, totalSteps = 3, userChoices = [];

    // --- Data ---
    const activityData = {
        steps: [
            { question: "What do you enjoy most?", themes: ["arts", "stem", "social", "mixed"], choices: ["Creating things (art, music)", "Solving problems (numbers, experiments)", "Helping people, exploring cultures", "Planning, organizing information"] },
            { question: "What are you naturally good at?", themes: ["arts", "stem", "social", "mixed"], choices: ["Expressing myself creatively", "Math, coding, or science", "Explaining things, understanding people", "Collecting and sorting information"] },
            { question: "Where do you want to make a difference?", themes: ["arts", "stem", "social", "mixed"], choices: ["On stage or in the field", "In a lab, clinic, or tech company", "In schools, courts, or communities", "In offices or businesses"] }
        ],
        results: { "1,1,1": { pathway: "Arts & Sports", track: "Performing Arts", feedback: "You are a natural on stage or in the field! The Performing Arts track in the Arts & Sports pathway is a great fit. You shine when you express yourself physically or creatively.", careers: ["Actor", "Dancer", "Sports Coach"] }, "1,1,3": { pathway: "Social Sciences", track: "Languages & Literature", feedback: "You are creative and expressive, but also love connecting with others. The Languages and Literature track lets you use your voice to inspire, inform, and lead.", careers: ["Writer", "Journalist", "Speaker"] }, "1,1,2": { pathway: "STEM", track: "Applied Sciences", feedback: "You love creativity and solving problems. The Applied Sciences track helps you use imagination in tech and science projects.", careers: ["Designer", "Technician", "Innovator"] }, "1,4,1": { pathway: "Arts & Sports", track: "Visual Arts", feedback: "You are observant and detail-oriented with a love for visuals. The Visual Arts track is perfect for creators who think and design with purpose.", careers: ["Illustrator", "Animator", "Fashion Designer"] }, "2,2,2": { pathway: "STEM", track: "Pure Sciences", feedback: "You are a born problem-solver! ðŸ§ª The Pure Sciences track is perfect for deep thinkers who love Chemistry, Physics, and exploring how the world works.", careers: ["Chemist", "Engineer", "Researcher"] }, "2,2,3": { pathway: "Social Sciences", track: "Humanities & Business", feedback: "You are logical and social, a rare combo! Humanities and Business lets you apply your analytical mind to real-world human needs.", careers: ["Economist", "Civic Planner", "Policy Advisor"] }, "2,2,4": { pathway: "STEM", track: "Applied Sciences", feedback: "Looks like you enjoy structure, systems, and solving. The Applied Sciences track is ideal for planners, coders, and inventors.", careers: ["Data Analyst", "Technician", "IT Expert"] }, "2,1,1": { pathway: "Arts & Sports", track: "Visual Arts", feedback: "A mix of logic and creativity! You could use both in Visual Arts, designing, planning, and creating with structure and beauty.", careers: ["Architect", "Multimedia Designer"] }, "3,3,3": { pathway: "Social Sciences", track: "Humanities & Business", feedback: "You've got a heart for people and the power to support them. The Humanities and Business track will equip you to make a difference in lives and communities.", careers: ["Social Worker", "Counsellor", "Teacher"] }, "3,1,2": { pathway: "STEM", track: "Applied Sciences", feedback: "You love people and creativity but enjoy solving problems too. The Applied Sciences track may help you work in areas like health or education technology.", careers: ["Health Technologist", "Instructional Designer"] }, "3,3,1": { pathway: "Arts & Sports", track: "Performing Arts", feedback: "You enjoy connecting through performance. Performing Arts gives you a platform to express yourself and inspire others!", careers: ["Actor", "Music Educator", "Choreographer"] }, "3,3,4": { pathway: "Social Sciences", track: "Humanities & Business", feedback: "You care deeply about people and systems. Humanities and Business is your bridge to roles that build a better society.", careers: ["Public Administrator", "NGO Officer"] }, "4,4,2": { pathway: "STEM", track: "Applied Sciences", feedback: "You are methodical and organized. The Applied Sciences track will help you apply logic and order to science and tech tasks.", careers: ["Statistician", "Lab Tech", "Process Analyst"] }, "4,4,4": { pathway: "Social Sciences", track: "Humanities & Business", feedback: "You are precise and process-oriented. Humanities and Business prepares you for systems-based roles in planning or admin.", careers: ["Records Officer", "HR Specialist", "Urban Planner"] }, "4,1,1": { pathway: "Arts & Sports", track: "Visual Arts", feedback: "A planner with a creative flair! The Visual Arts track blends imagination with structure in design and crafts.", careers: ["Set Designer", "Graphic Artist"] }, "1,3,3": { pathway: "Social Sciences", track: "Languages & Literature", feedback: "You connect through stories and words. The Languages & Literature track gives you the tools to express and inspire.", careers: ["Poet", "Language Teacher", "Author"] }, "default": { pathway: "Multi-Talented Explorer", track: "Flexible Pathway", feedback: "Hmmâ€¦ your interests are wide, and thatâ€™s great! Your unique combination of skills means you can blend talents from different fields. Consider looking at interdisciplinary tracks like Environmental Planning or Data for Social Change that combine STEM, Social Sciences, and creativity.", careers: ["Innovator", "Consultant", "Entrepreneur"] } }
    };
    const hintContent = [ "Try a dual interest suggestion like: Arts & Sports + Social Sciences", "Or: STEM + Social Sciences (e.g., Environmental Planning, Data for Social Change)"];

    // --- Sound ---
    function playSound(sound) { if(sound) { sound.currentTime = 0; sound.play().catch(e => {}); } }
    function stopSound(sound) { if(sound) { sound.pause(); sound.currentTime = 0; } }

    // --- UI Update ---
    function updateProgress() {
        progressBar.style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
        progressText.textContent = `${currentStep + 1} / ${totalSteps}`;
        if (currentStep >= totalSteps) {
            progressText.textContent = `${totalSteps} / ${totalSteps}`;
            progressBar.style.width = '100%';
        }
    }

    function createNode(type, text, theme = '') {
        const node = document.createElement('div');
        node.className = `node ${type}-node`;
        node.textContent = text;
        if (theme) node.dataset.theme = theme;
        return node;
    }

    function displayStep(stepIndex) {
        isPaused = true;
        treeContainer.innerHTML = '';
        svgCanvas.innerHTML = svgCanvas.querySelector('defs').outerHTML; // Keep defs
        const stepData = activityData.steps[stepIndex];
        const containerRect = treeContainer.getBoundingClientRect();

        const rootNode = createNode('root', stepData.question);
        treeContainer.appendChild(rootNode);
        rootNode.style.left = `${containerRect.width / 2 - rootNode.offsetWidth / 2}px`;
        rootNode.style.top = `${containerRect.height * 0.15 - rootNode.offsetHeight / 2}px`;
        setTimeout(() => rootNode.classList.add('visible'), 100);

        const leafNodes = [];
        const numChoices = stepData.choices.length;
        const totalAngle = Math.PI; // 180 degrees arc
        const startAngle = -Math.PI / 2 - totalAngle / 2; // Center the arc at the bottom

        stepData.choices.forEach((choice, i) => {
            const leafNode = createNode('leaf', choice, stepData.themes[i]);
            leafNode.dataset.choiceIndex = i + 1;
            treeContainer.appendChild(leafNode);
            
            const angle = startAngle + (numChoices > 1 ? (i / (numChoices - 1)) * totalAngle : 0);
            const x = containerRect.width / 2 + Math.cos(angle) * (containerRect.width * 0.42);
            const y = containerRect.height * 0.7 + Math.sin(angle) * (containerRect.height * 0.2);
            
            leafNode.style.left = `${x - leafNode.offsetWidth / 2.9}px`;
            leafNode.style.top = `${y - leafNode.offsetHeight / 2}px`;
            leafNodes.push(leafNode);

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const rootX = parseFloat(rootNode.style.left) + rootNode.offsetWidth / 2;
            const rootY = parseFloat(rootNode.style.top) + rootNode.offsetHeight;
            const leafX = x;
            const leafY = parseFloat(leafNode.style.top);
            // Adjusted control points for a smoother curve
            path.setAttribute('d', `M ${rootX} ${rootY} C ${rootX} ${rootY + 80}, ${leafX} ${leafY - 80}, ${leafX} ${leafY}`);
            path.setAttribute('class', 'connector-line');
            path.dataset.theme = stepData.themes[i];
            path.style.animationDelay = `${0.5 + i * 0.2}s`;
            svgCanvas.appendChild(path);

            setTimeout(() => leafNode.classList.add('visible'), 1200 + i * 200);
        });
        
        setTimeout(() => {
            isPaused = false;
            leafNodes.forEach(node => node.addEventListener('click', handleChoiceClick));
        }, 2000);
    }
    
    function handleChoiceClick(event) {
        if (isPaused) return;
        isPaused = true;
        const selectedCard = event.currentTarget;
        const selectedChoiceIndex = parseInt(selectedCard.dataset.choiceIndex);
        userChoices.push(selectedChoiceIndex);
        playSound(dingSound);
        
        selectedCard.classList.add('selected');
        document.querySelectorAll('.leaf-node:not(.selected), .root-node').forEach(node => node.classList.add('faded'));
        
        setTimeout(() => {
            document.querySelectorAll('.node').forEach(n => n.classList.add('hiding'));
            svgCanvas.querySelectorAll('path').forEach(p => p.style.opacity = '0');
        }, 1000);

        setTimeout(() => {
            currentStep++;
            if (currentStep < totalSteps) {
                updateProgress();
                displayStep(currentStep);
            } else {
                updateProgress();
                showResult();
            }
        }, 1500);
    }
    
    function showResult() {
        const resultKey = userChoices.join(',');
        const result = activityData.results[resultKey] || activityData.results['default'];
        document.getElementById('result-pathway-track').textContent = `${result.pathway}: ${result.track}`;
        document.getElementById('result-feedback').textContent = result.feedback;
        const careersList = resultOverlay.querySelector('.careers-list');
        careersList.innerHTML = result.careers.map(career => `<li>${career}</li>`).join('');
        resultOverlay.classList.remove('hidden');
        announce(`Your result is: ${result.pathway}, ${result.track}.`);
    }
    
    function showCompletion() {
        resultOverlay.classList.add('hidden');
        completionOverlay.classList.remove('hidden');
        announce("Activity Complete");
        playSound(outroSound);
    }

    function restartGame() {
        stopSound(outroSound);
        completionOverlay.classList.add('hidden');
        setupActivity();
    }

    function setupActivity() {
        currentStep = 0;
        userChoices = [];
        resultOverlay.classList.add('hidden');
        completionOverlay.classList.add('hidden');
        updateProgress();
        displayStep(0);
    }
    
    function announce(text) { announcer.textContent = text; }

    function showHint() {
        isPaused = true;
        hintList.innerHTML = hintContent.map(item => `<li>${item}</li>`).join('');
        hintOverlay.classList.remove('hidden');
    }

    function closeModal(overlayElement) {
        overlayElement.classList.add('hidden');
        if (currentStep < totalSteps) { isPaused = false; }
    }
    
    function init() {
        startBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            activityIntroOverlay.classList.remove('hidden');
            playSound(introSound);
            sendEvent(ActivityEvent.START_ACTIVITY, { activityName: 'Find Your Fit!' });
        });
        introContinueBtn.addEventListener('click', () => {
            activityIntroOverlay.classList.add('hidden');
            setupActivity();
            stopSound(introSound);
        });
        
        instructionsIcon.addEventListener('click', () => { isPaused = true; instructionsModalOverlay.classList.remove('hidden'); });
        closeInstructionsBtn.addEventListener('click', () => closeModal(instructionsModalOverlay));
        
        hintIcon.addEventListener('click', showHint);
        closeHintBtn.addEventListener('click', () => closeModal(hintOverlay));
        
        resultOverlay.querySelector('.continue-btn').addEventListener('click', showCompletion);
        
        completionOverlay.querySelector('.btn-restart').addEventListener('click', restartGame);
        // Add placeholders for previous/next activity navigation
        completionOverlay.querySelector('.btn-previous').addEventListener('click', () => {
            window.location.href = "../ACTIVITY1/index.html";
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Find Your Fit!' });
        });
        completionOverlay.querySelector('.btn-next').addEventListener('click', () => {
            window.location.href = "../ACTIVITY3/index.html";
            sendEvent(ActivityEvent.END_ACTIVITY, { activityName: 'Find Your Fit!' });
        });
    }

    init();
});
</script>
<script src="../eventSender.js"></script>
</body>
</html>