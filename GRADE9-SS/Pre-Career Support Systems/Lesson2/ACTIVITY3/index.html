<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family or Future? – The Decision Challenge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ====== FONT IMPORTS ====== */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar{
            display: none;
        }
        /* ====== ROOT VARIABLES & SCALING ====== */
        :root {
            --font-xs: 1.1rem;
            --font-sm: 1.4rem;
            --font-md: 1.4rem;
            --font-lg: 2rem;
            --font-xl: 4rem;
            --pad-sm: 1rem;
            --pad-md: 1.6rem;
            --pad-lg: 2.4rem;
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --feedback-color: #5cb85c;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --border-radius: 1rem;
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: var(--header-font);
        }
        
        html {
             font-size: 1.8vmin;
        }

        /* ===== HIDE SCROLLBAR ===== */
        body::-webkit-scrollbar, .scenario-content::-webkit-scrollbar, .modal::-webkit-scrollbar { display: none; }
        body, .scenario-content, .modal { scrollbar-width: none; -ms-overflow-style: none; }

        /* ====== GLOBAL BASE ====== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #f0f4f8;
            font-family: var(--body-font);
            overflow: hidden;
        }
        #game-wrapper {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex; flex-direction: column; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        #game-container {
            width: 100%; height: 100%; background: #fff;
            position: relative; display: flex; flex-direction: column;
        }
        .screen {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-in-out, visibility 0.5s;
            pointer-events: all; visibility: visible;
        }
        .hidden { opacity: 0; pointer-events: none; visibility: hidden; }

        /* ===== START SCREEN ===== */
        #start-screen {
            color: var(--text-color-light); text-align: center; padding: 2rem;
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        }
        #start-screen h1 {
            color: var(--text-color-light);
            font-size: 4rem;
            font-family: var(--header-font);
            font-weight: 500;
        }
        .start-button {
            font-family: var(--header-font);
            background: var(--secondary-color);
            color: var(--text-color-light);
            font-weight: 500;
            font-size: 1.2rem;
            border: 3px solid #fff;
            border-radius: 4.8rem;
            padding: var(--pad-sm) var(--pad-lg);
            margin-top: 1.6rem;
            cursor: pointer;
            text-shadow: 0 0.2rem 0 #b88b2a;
            transition: all 0.2s;
        }
    
        .start-button:hover { transform: scale(1.06); }

        /* ===== GAME SCREEN STYLES ===== */
        #game-screen { 
            justify-content: flex-start; 
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .game-top-section {
            width: 100%; background-color: #5D04B2; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
            display: flex; justify-content: space-between; align-items: center;
            color: #fff; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
    
        #game-title {
            font-weight: 600;
            margin: 0; font-family: var(--header-font);
        }
    
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        
        #progress-container { 
            width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
            border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
            border: 2px solid #fff; position: relative; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%; background: #FFFF00;
            border-radius: 0.8rem; transition: width 0.5s ease;
        }
        #progress-text {
            font-weight: 600; color: #fff;
            text-shadow: none;
        }

        .instructions-icon {
            width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;
            z-index: 15; flex-shrink: 0;
            animation: glow-pulse-white 2s infinite;
        }
        .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white;}

        /* ===== MODALS ===== */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .overlay.hidden { display: none; visibility: hidden; opacity: 0; }
        .modal {
            background: #fff; padding: 2.5rem; border-radius: 1rem;
            text-align: center; width: 90%; max-width: 40vw;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); } }

        .modal h2 {
            font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem;
            font-family: var(--header-font);
        }
        .modal p, .modal ul, .modal ol { font-size: 1.5rem; line-height: 1.6; color: var(--text-color-dark, #333); }
        
        #activity-intro-overlay .modal, #instructions-overlay .modal, #outcome-summary-overlay .modal { border-top: 8px solid var(--primary-color); }
        #activity-intro-overlay .modal h2, #instructions-overlay .modal h2, #outcome-summary-overlay .modal h2 { color: var(--primary-color); }
        #activity-intro-overlay .modal p {
            text-align: left; background: #f8f9fa; padding: 1.5rem;
            border-radius: 0.75rem; border-left: 4px solid var(--primary-color);
        }
        
        #instructions-overlay .modal ol { text-align: left; padding-left: 2rem; font-size: 1.2rem; }

        /* Modal Buttons */
        .modal button {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 700;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            transition: transform 0.2s, box-shadow 0.2s; margin-top: 1rem;
        }
        .modal button:hover { transform: scale(1.02); }
        #activity-intro-overlay button, #instructions-overlay button, #outcome-summary-overlay button { background-color: var(--primary-color); }

        /* Feedback Modal */
        .feedback-modal {border-top: 8px solid var(--feedback-color) !important; }
        .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
        .feedback-header h2 { font-size: 2rem; font-weight: 700; color: var(--feedback-color); }
        .feedback-btn { background-color: var(--feedback-color) !important; }

        /* ===== COMPLETION SCREEN ===== */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
            color: #fff; display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 1rem; padding: 1rem;
        }
        .completion-title-banner { 
            font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 500;
        }
        #completion-overlay .modal { 
            background: transparent; box-shadow: none; width: auto; max-width: none;
            display: flex; justify-content: center; align-items: center;
            padding: 0; overflow: visible;
        }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid #FBB03B; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-top: 0.5rem;
        }
        .completion-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            width: 100%;
            padding: 1rem 2rem;
        }
        .completion-btn {
            font-family: var(--header-font); background: var(--secondary-color); color: #fff;
            font-weight: 500; 
            font-size: 1.3rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none;
            min-width: 8.75rem; /* 140px */
        }
        .completion-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0.5rem 1.25rem rgba(0,0,0,0.2);
        }
    
        /* ===== TAKEAWAYS OVERLAY ===== */
        #takeaways-overlay {
            background-image: url(images/gamebg.jpg); flex-direction: column; justify-content: center;
        }
        .takeaways-main-header {
            font-family: var(--header-font); color: white; font-size: 2.5rem;
            position: absolute; top: 5%; text-align: center; width: 100%;
            text-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.3);
        }
        #takeaways-overlay .modal {
            max-width: 800px;
            padding: 2rem; 
            display: flex;
            flex-direction: column; 
            align-items: center;
            height: 45vh;
            overflow-y: auto;
            margin-top: 3rem;
            border-top: 3px solid var(--secondary-color);
        }
        .takeaways-header { color:var(--primary-color); display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem; }
        .takeaways-header h3 { font-family: var(--header-font); font-size: 1.8rem; color: var(--primary-color); }
        #takeaways-list { list-style-type: none; padding: 0; width: 100%; }
        #takeaways-list li {
            background: none;
            border-left: none;
            margin-bottom: 0rem;
            padding: 1rem 1rem 1rem 2.5rem;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            text-align: left;
            position: relative;
        }
        #takeaways-list li::before {
            content: '';
            display: inline-block;
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.2rem;
            height: 1.2rem;
            background: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%235cb85c" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 10.8 17 4 10.8"/></svg>');
            background-size: 1.2rem 1.2rem;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .end-lesson-btn {
            background: var(--secondary-color);
            font-family: var(--header-font);
            color: #fff;
            font-weight: 500;
            font-size: 1.3rem;
            border: 3px solid #fff;
            border-radius: 3rem;
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            text-shadow: 0 2px 0 #b88b2a;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: auto;
            min-width: 180px;
            margin-top: 2rem;
        }
        .end-lesson-btn:hover { transform: scale(1.06); box-shadow: 0 6px 24px rgba(0,0,0,0.18); }

        /* ===== SCENARIO LAYOUT ===== */
        .scenario-title {
            font-family: var(--header-font); color: var(--primary-color);
            font-size: 2.2rem; text-align: center; padding: 1rem;
            width: 100%; margin-bottom: 0.5rem; flex-shrink: 0;
        }
        .scenario-content {
            flex: 1; padding: 1rem 2rem; overflow: auto; display: flex;
            justify-content: center; align-items: center; margin-top: 0;
        }
        .scenario-container {
            display: flex; gap: 2rem; align-items: center; width: 100%;
            max-width: 80rem; padding: 1rem; background: #fff;
            border-radius: var(--border-radius); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            opacity: 1; transition: opacity 0.3s ease-in-out; height: 55vh;
        }
        .scenario-container.fade-out { opacity: 0; }
        
        .scenario-details { flex: 1 1 50%; display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .scenario-story { font-size: 1.3rem; color: #444; line-height: 1.7; background: #f8f9fa; border-left: 0.25rem solid var(--primary-color); padding: 1.5rem; border-radius: 0.8rem; text-align: left; width: 100%; }
        
        .question-section {
            flex: 1 1 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background-color: #f2f0f5;
            padding: 1.5rem;
            border-radius: var(--border-radius);
        }
        .question-section h3 { font-family: var(--header-font); color: var(--text-color-dark); font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; font-weight: 500;}
        
        .options-container { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 450px; }
        .option-button {
            background: #fff; border: 2px solid #ddd; border-radius: 1rem; padding: 1.2rem; cursor: pointer;
            transition: all 0.3s ease; font-size: 1.2rem; color: var(--text-color-dark); font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); text-align: left;
        }
        .option-button:hover:not(:disabled) { transform: translateY(-3px); border-color: var(--primary-color); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .option-button:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Selected option visual (green border) */
        .option-button.selected {
            border-color: var(--correct-color) !important;
            box-shadow: 0 8px 20px rgba(92,184,92,0.15);
        }

        /* ===== Glowing Pulsating Effect Keyframes ====== */
        @keyframes glow-pulse-white { 0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(255,255,255,0.5); transform: scale(1); } 50% { box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 30px rgba(255,255,255,0.7); transform: scale(1.1); } }

        /* ===== RESPONSIVE DESIGN ===== */
        @media(min-width: 1200px) { 
            .question-section {
                height: 50vh;
                overflow-y: auto;
            }
            .scenario-story {
                font-size: 1.5em;
                color: #444;
                line-height: 2;
                background: #f8f9fa;
                border-left: 0.25rem solid var(--primary-color);
                padding: 1.5rem;
                border-radius: 0.8rem;
                text-align: left;
                width: 100%;
                height: 30vh;
            }
        }

        @media (max-width: 1199px) {
            html { 
                font-size: 2vmin; 
            } 
           #activity-intro-overlay .modal, #instructions-overlay .modal, #outcome-summary-overlay .modall{
                max-width: 60vw;
            }
        }
        @media (max-width: 1024px) {
            #game-wrapper { width: 100vw; height: 100vh; border-radius: 0; aspect-ratio: unset; }
            .question-section{
                height: 50vh;
                overflow-y: auto;
            }
        } 
        @media (max-width: 991px) {
            html{ font-size: 3vmin; }
            .scenario-container {
                /* flex-direction: column; */
                height: 85vh;
                max-height: 100%;
                overflow-y: auto;
                padding: 1.5rem;
            }
                .completion-buttons { flex-direction: column; align-items: center; }
            #takeaways-overlay .modal{
                height: 60vh
            }
            .completion-title-banner{
                top:1%;
            }
            .completion-image {
                width: 57%;
            }
            .options-container {
                display: flex;      
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }
            .question-section {
                height: 66vh;
            }
            #activity-intro-overlay .modal, #instructions-overlay .modal, #outcome-summary-overlay .modall{
                max-width: 70vw;
            }
            #completion-image {
                max-width: 58%;
            }
        }
        @media (max-width: 768px) {
            html { font-size: 3.3vmin; }
            .scenario-title { font-size: 1.8rem; }
            .scenario-content { padding: 1rem; }
            .completion-title-banner { font-size: 1.8rem; }
            #completion-image { max-width: 66%; }
            .completion-btn { min-width: 155px; }
            .question-section h3{
                font-size: 1.2rem;
            }
            .option-button{
                font-size: 1rem;    
                padding: 1rem;
            }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <div id="start-screen" class="screen">
            <h1 id="start-title"></h1>
            <button class="start-button" onclick="showActivityIntro();">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
                <h1 id="game-title"></h1>
                <div class="top-right-controls">
                    <div id="progress-container">
                        <div id="progress-bar"></div>
                    </div>
                    <span id="progress-text">0 / 3</span>
                    <div class="instructions-icon" onclick="showInstructions()">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
            </div>

            <h2 class="scenario-title" id="scenario-title"></h2>
            
            <div class="scenario-content">
                <div class="scenario-container" id="scenario-container">
                    <div class="scenario-details">
                        <p class="scenario-story" id="scenario-story-text"></p>
                    </div>
                    <div class="question-section">
                        <h3 id="question-text"></h3>
                        <div class="options-container" id="options-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="outcome-summary-overlay" class="overlay hidden">
            <div class="modal">
                <h2 id="outcome-title"></h2>
                <p id="outcome-summary-text"></p>
                <button onclick="showCompletionScreen()">Continue</button>
            </div>
        </div>

        <div id="completion-overlay" class="overlay hidden">
            <h2 class="completion-title-banner" id="completion-title">Activity Wrap Up!</h2>
            <img id="completion-image" src="images/complete.jpg" alt="Activity Complete Summary">
            <div class="completion-buttons">
                <button class="completion-btn btn-prev" onclick="goToPreviousActivity()">Previous Activity</button>
                <button class="completion-btn btn-restart" onclick="restartGame()">Restart Activity</button>
                <button class="completion-btn btn-next" onclick="showTakeaways()">Key Takeaways</button>
            </div>
        </div>

        <div id="takeaways-overlay" class="overlay hidden">
            <h2 class="takeaways-main-header">Lesson Complete</h2>
            <div class="modal">
                <div class="takeaways-header">
                    <h3>Key Takeaways</h3>
                </div>
                <ul id="takeaways-list"></ul>
            </div>
            <button class="end-lesson-btn" onclick="sendEvent(LessonEvent.END_LESSON, {lessonName: 'Analysing Challenges in Current Support Systems: Lesson 2'})">Brain Power Checkpoint</button>
        </div>

        <div id="activity-intro-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Activity Introduction</h2>
                <p id="intro-text"></p>
                <button onclick="closeModal('activity-intro-overlay')">Continue</button>
            </div>
        </div>

        <div id="instructions-overlay" class="overlay hidden">
            <div class="modal">
                <h2>Instructions</h2>
                <ol id="instructions-list"></ol>
                <button onclick="closeModal('instructions-overlay')">Got it!</button>
            </div>
        </div>
        
        <div id="feedback-overlay" class="overlay hidden">
            <div class="modal feedback-modal">
                <div class="feedback-header">
                    <h2>Decision Feedback</h2>
                </div>
                <p id="feedback-text"></p>
                <button class="feedback-btn" onclick="goToNextStep()">Continue</button>
            </div>
        </div>
    </div>
</div>

<script>
    const activityData = {
        title: "Family or Future? ",
        introduction: "You have a dream to fly high and become a pilot! But your family wants you to stay close to home and take over the family farm. What would you do? In this challenge, you will step into the shoes of a student facing this tough choice. Think carefully about who to talk to, what to say, and how your decisions shape your future.",
        instructions: [
            "At each step, choose what Kimani should do or say.",
            "Your decision will lead to different outcomes, some positive, some challenging.",
            "Each feedback will give you hints to improve your decision-making.",
            "Your choices will shape Kimani’s relationship with his family and his path toward becoming a pilot."
        ],
        wrapUp: "Activity Conclusion",
        keyTakeaways: [
            "Common challenges include lack of awareness, fear of judgment, confidentiality concerns, conflicting advice, lack of confidence, passive participation, accessibility issues, and limited scope of programs.",
            "These challenges can stem from factors like limited school resources, high demand, lack of communication, or personal feelings.",
            "Recognizing these challenges is crucial for finding ways to overcome them."
        ],
        character: {
            name: "Kimani",
            role: "Grade 8 learner",
            dream: "Pilot",
            familyExpectation: "Farmer"
        },
        decisionPoints: [
            {
                story: "You are Kimani, a Grade 8 learner. Your dream is to become a <strong>pilot</strong>, but your family expects you to take over the family <strong>farm</strong>. This is your first big decision.",
                question: "Who do you talk to first?",
                options: [
                    { text: "Keep quiet and follow your parents’ wishes", feedback: "It is respectful, but keeping your feelings inside can lead to frustration later. Let us explore other ways to be honest and respectful.", pathId: 'A' },
                    { text: "Talk to your guidance counsellor", feedback: "Smart move! Guidance counsellors help you think clearly and respectfully express your career interests.", pathId: 'B' },
                    { text: "Talk to a trusted older cousin who’s in college", feedback: "Good idea! Talking to someone who understands both your dreams and your family’s values is helpful.", pathId: 'C' }
                ]
            },
            {
                story: "After deciding who to approach first, you now need to prepare your message for your parents. The way you communicate is very important.",
                question: "What is your message to your parents?",
                options: [
                    { text: "“I don’t care what you want, I’ll be a pilot!”", feedback: "This might cause conflict. Being rude can close doors instead of opening minds.", pathId: 'A' },
                    { text: "“I appreciate the farm, but I’d love to explore aviation. Can we talk about it?”", feedback: "Excellent approach! Respect + honesty builds trust and understanding.", pathId: 'B' },
                    { text: "“You are wrong. Piloting pays more.”", feedback: "Money shouldn’t be the only reason. Try to share your passion and interest too.", pathId: 'C' }
                ]
            },
            {
                story: "Words are powerful, but action shows you are serious. You need a plan to show your commitment to your dream while still respecting your family.",
                question: "What is your action plan?",
                options: [
                    { text: "Research aviation careers and training paths", feedback: "Great! Showing initiative proves you are serious and prepared.", pathId: 'A' },
                    { text: "Refuse to help with the farm at all", feedback: "This may damage your relationship. You can still respect your roots while planning your future.", pathId: 'B' },
                    { text: "Stay silent and hope they change their minds", feedback: "Waiting without action could mean missed opportunities. Let us take confident steps forward.", pathId: 'C' }
                ]
            }
        ],
        outcomes: {
            'BBA': { title: "Positive Outcome!", summary: "Kimani’s parents listened and agreed to help him apply to a flying school. Respect and planning paid off!" },
            'CBA': { title: "Positive Outcome!", summary: "Kimani’s cousin helped him talk to his parents. They were surprised but eventually supportive." },
            'AAB': { title: "Challenging Outcome", summary: "Kimani’s parents were hurt by his words and refused to support him. His dream now feels more distant." },
            'BCC': { title: "Stalled Progress", summary: "Kimani got advice, but did not act on it. The conversation with parents never happened." },
            'default': { title: "Mixed Result", summary: "Your path led to a complex situation. While some progress was made, clear communication and a solid plan are still needed to convince your family and move forward."}
        }
    };

    let currentStepIndex = 0;
    let userPath = [];
    const totalSteps = activityData.decisionPoints.length;
    let introAudio, dingAudio, buzzAudio, outroAudio;

    function initAudio() {
        try {
            introAudio = new Audio('audio/intro.mp3');
            dingAudio = new Audio('audio/ding.mp3');
            buzzAudio = new Audio('audio/buzz.mp3');
            outroAudio = new Audio('audio/outro.mp3');
        } catch (e) {
            console.warn("Audio could not be loaded.");
            const mockAudio = { play: () => {}, pause: () => {}, currentTime: 0 };
            introAudio = dingAudio = buzzAudio = outroAudio = mockAudio;
        }
    }

    function playSound(audio) { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); } }
    function stopSound(audio) { if(audio) { audio.pause(); } }

    function loadStep() {
        const step = activityData.decisionPoints[currentStepIndex];
        
        document.getElementById('scenario-title').textContent = `Step ${currentStepIndex + 1}: The Choice`;
        document.getElementById('scenario-story-text').innerHTML = step.story;
        document.getElementById('question-text').textContent = step.question;
        
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        const optionLabels = ['A', 'B', 'C'];

        step.options.forEach((optionData, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.innerHTML = `<strong>${optionLabels[index]}.</strong> ${optionData.text}`;
            button.onclick = () => handleOptionClick(optionData, button);
            optionsContainer.appendChild(button);
        });
        
        updateProgress();
    }
    
    function handleOptionClick(optionData, clickedButton) {
        // Visual selection: clear previous and mark current
        document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
        clickedButton.classList.add('selected');

        playSound(dingAudio);
        userPath.push(optionData.pathId);

        // Disable all buttons after a choice is made
        document.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);

        showFeedbackPopup(optionData.feedback);
    }

    function goToNextStep() {
        closeModal('feedback-overlay');
        const container = document.getElementById('scenario-container');
        container.classList.add('fade-out');
        
        setTimeout(() => {
            currentStepIndex++;
            if (currentStepIndex < totalSteps) {
                loadStep();
     
                container.classList.remove('fade-out');
            } else {
                showOutcomeSummary();
            }
        }, 300);
    }

    function showOutcomeSummary() {
        const pathKey = userPath.join('');
        const outcome = activityData.outcomes[pathKey] || activityData.outcomes['default'];

        document.getElementById('outcome-title').textContent = outcome.title;
        document.getElementById('outcome-summary-text').innerHTML = outcome.summary;

        document.getElementById('outcome-summary-overlay').classList.remove('hidden');
    }

    function showCompletionScreen() {
        playSound(outroAudio); // Play sound at summary

        document.getElementById('outcome-summary-overlay').classList.add('hidden');
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('completion-overlay').classList.remove('hidden');
        
        document.getElementById('completion-title').textContent = activityData.wrapUp;
        
        // Update progress bar to full on completion
        document.getElementById('progress-bar').style.width = `100%`;
        document.getElementById('progress-text').textContent = `${totalSteps} / ${totalSteps}`;
    }
    
    function updateProgress() {
        const progress = currentStepIndex;
        document.getElementById('progress-bar').style.width = `${(progress / totalSteps) * 100}%`;
        document.getElementById('progress-text').textContent = `${progress} / ${totalSteps}`;
    }

    function showFeedbackPopup(message) {
        document.getElementById('feedback-text').innerHTML = message;
        document.getElementById('feedback-overlay').classList.remove('hidden');
    }
    
    function showActivityIntro() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('activity-intro-overlay').classList.remove('hidden');
        playSound(introAudio);
        sendEvent(ActivityEvent.START_ACTIVITY, {activityName: activityData.title});
    }

    function showInstructions() { document.getElementById('instructions-overlay').classList.remove('hidden'); }
    
    function showTakeaways() { 
        document.getElementById('completion-overlay').classList.add('hidden');
        stopSound(outroAudio);
        document.getElementById('takeaways-overlay').classList.remove('hidden'); 
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: activityData.title});
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'activity-intro-overlay') { 
            stopSound(introAudio); 
            loadStep(); // Initial load
        }
    }
    
    function restartGame() {
        stopSound(outroAudio);
        document.getElementById('completion-overlay').classList.add('hidden');
        document.getElementById('takeaways-overlay').classList.add('hidden');
        currentStepIndex = 0;
        userPath = [];
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('scenario-container').classList.remove('fade-out');
        loadStep();
    }

    function goToPreviousActivity() { 
        window.location.href = "../ACTIVITY2/index.html"; 
        stopSound(outroAudio);
        sendEvent(ActivityEvent.END_ACTIVITY, {activityName: activityData.title});
    }
    
    function populateStaticContent() {
        document.getElementById('start-title').textContent = activityData.title;
        document.getElementById('game-title').textContent = activityData.title;
        document.getElementById('intro-text').innerHTML = activityData.introduction;
        
        const instructionsList = document.getElementById('instructions-list');
        instructionsList.innerHTML = activityData.instructions.map(item => `<li>${item}</li>`).join('');

        const takeawaysList = document.getElementById('takeaways-list');
        takeawaysList.innerHTML = activityData.keyTakeaways.map(item => `<li>${item}</li>`).join('');

        document.getElementById('progress-text').textContent = `0 / ${totalSteps}`;
    }

    window.onload = () => { initAudio(); populateStaticContent(); };
</script>
<script src="../eventSender.js"></script>
</body>
</html>