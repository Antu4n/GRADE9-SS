<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Mapping</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ====== FONT IMPORTS ====== */
        @font-face {
            font-family: 'Fredoka';
            src: url('../assets/Fredoka-VariableFont_wdth\,wght.ttf') format('truetype');
        }
        ::-webkit-scrollbar{
            display: none;
        }
        /* ====== ROOT VARIABLES & SCALING ====== */
        :root {
            --primary-color: #5D04B2;
            --secondary-color: #FBB03B;
            --correct-color: #5cb85c;
            --incorrect-color: #d9534f;
            --text-color-dark: #333;
            --text-color-light: #fff;
            --border-radius: 1rem;
            --header-font: 'Fredoka', 'Poppins', sans-serif;
            --body-font: var(--header-font);
            --light-bg: #f4f1e9;
            --drop-zone-bg: #e9e5d9;
        }
        
        html {
             font-size: 1.8vmin;
        }

        /* ===== HIDE SCROLLBAR ===== */
        body::-webkit-scrollbar, .scenario-content::-webkit-scrollbar, .modal-content::-webkit-scrollbar { display: none; }
        body, .scenario-content, .modal-content { scrollbar-width: none; -ms-overflow-style: none; }

        /* ====== GLOBAL BASE ====== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: #f0f4f8;
            font-family: var(--body-font);
            overflow: hidden;
        }
        #game-wrapper {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9;
            overflow: hidden;
            display: flex; flex-direction: column; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        #game-container {
            width: 100%; height: 100%; background: #fff;
            position: relative; display: flex; flex-direction: column;
        }
        .screen {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }

        /* ===== START SCREEN ===== */
        #start-screen {
            color: var(--text-color-light); text-align: center; padding: 2rem;
            background-image: url('images/gamebg.jpg'); 
            background-size: cover; background-position: center;
        }
        #start-screen h1 {
            color: var(--text-color-light);
            font-size: 4rem;
            font-family: var(--header-font);
            font-weight: 500;
        }
        .start-button {
            font-family: var(--header-font);
            background: var(--secondary-color);
            color: var(--text-color-light);
            font-weight: 500;
            font-size: 1.2rem;
            border: 3px solid #fff;
            border-radius: 4.8rem;
            padding: 1rem 2.4rem;
            margin-top: 1.6rem;
            cursor: pointer;
            text-shadow: 0 0.2rem 0 #b88b2a;
            transition: all 0.2s;
        }
        .start-button:hover { transform: scale(1.06); }

        /* ===== GAME SCREEN ===== */
        #game-screen { 
            justify-content: flex-start; 
            overflow: hidden; 
            position: relative;
            background-color: var(--light-bg);
        }
        
        .game-top-section { 
            width: 100%; background-color: var(--primary-color); 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(0.75rem, 2vmin, 1.25rem);
            display: flex; justify-content: space-between; align-items: center;
            color: #fff; z-index: 20;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        #game-title {
            font-weight: 600;
            margin: 0; 
            font-family: var(--header-font);
            font-size: 1.5rem;
        }
        .top-right-controls { display: flex; align-items: center; gap: 1rem; }
        
        #progress-container { 
            width: clamp(100px, 20vw, 200px); background-color: rgba(255,255,255,0.3);
            border-radius: 1rem; height: clamp(15px, 2.5vmin, 20px);
            border: 2px solid #fff; position: relative; overflow: hidden;
        }
        #progress-bar {
            height: 100%; width: 0%; background: #FFFF00;
            border-radius: 0.8rem; transition: width 0.5s ease;
        }
        #progress-text { font-weight: 600; color: #fff; }

        .instructions-icon {
            width: 2.5rem; height: 2.5rem; background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.3s ease; animation: glow-pulse-white 3s infinite;
        }
        .instructions-icon:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .instructions-icon svg { width: 1.25rem; height: 1.25rem; fill: white;}

        .hint-icon {
            position: absolute; bottom: 1.5rem; right: 1.5rem; width: 3.5rem; height: 3.5rem;
            background: var(--secondary-color); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            z-index: 3002; border: 3px solid white; 
            transition: all 0.2s ease-out;
            animation: glow-pulse 2s infinite;
        }
        .hint-icon:hover { transform: scale(1.1); }
        .hint-icon svg { fill: white; width: 1.8rem; height: 1.8rem; }

        /* ===== STORYBOOK STYLE ===== */
        .scenario-title {
            font-family: var(--header-font); color: var(--text-color-dark);
            font-size: 2.2rem; text-align: center; padding: 1rem;
            width: 100%; flex-shrink: 0; font-weight: 600;
        }
        .scenario-content {
            flex: 1; padding: 1rem 2rem; overflow: hidden; display: flex;
            justify-content: center; align-items: center;
            perspective: 2500px;width: 100%;
        }
        .book-container {
            width: 95%; max-width: 90rem; height: 95%; display: flex;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4), inset 0 0 10px rgba(0,0,0,0.5);
        }
        .book-container::before {
            content: ''; position: absolute; top: 0; left: 50%;
            transform: translateX(-50%); width: 1.5rem; height: 100%;
            background-image: linear-gradient(to right, rgba(0,0,0,0.3), rgba(0,0,0,0) 30%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.3));
            z-index: 10;
        }
        .book-page {
            flex: 1; background: #FAF3E0; padding: 2rem;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 1.5rem;
            box-shadow: inset 5px 0 15px -5px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
            opacity: 1; transition: opacity 0.3s ease-in-out;
        }
        .book-page.left { border-right: 1px solid #ddd; }
        .scene-description { 
            font-size: 1.4rem; color: var(--text-color-dark); line-height: 1.7;
            text-align: center; width: 100%; font-family: var(--body-font);
        }
        #panel-image {
            width: 100%; max-width: 84%; height: auto; max-height: 90%;
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            cursor: pointer; transition: transform 0.2s ease;
            object-fit:inherit;
        }
        #panel-image:hover { transform: scale(1.03); }

        /* ===== 3D PAGE FLIP ANIMATION ===== */
        #page-turner {
            position: absolute; top: 0; left: 50%; width: 50%; height: 100%;
            transform-origin: left; transform-style: preserve-3d;
            display: none; z-index: 15; pointer-events: none;
        }
        #page-turner.turning-next { display: block; animation: turn-page-next 1s forwards ease-in-out; }
        #page-turner .page-content {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 1.5rem; overflow: hidden;
            background: #FAF3E0; padding: 2rem;
        }
        #page-turner .front { box-shadow: inset -8px 0 15px -5px rgba(0,0,0,0.3); }
        #page-turner .back { box-shadow: inset 8px 0 15px -5px rgba(0,0,0,0.3); transform: rotateY(180deg); }
        @keyframes turn-page-next { from { transform: rotateY(0deg); } to { transform: rotateY(-180deg); } }


        /* ===== MODAL STYLES ===== */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            z-index: 3000; display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background: #fff; padding: 2.5rem;
            border-radius: var(--border-radius); text-align: center;
            width: 90%; max-width: 600px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); } }
        .modal-content h2 {
            font-size: 2rem; font-weight: 600; margin-bottom: 1.5rem;
            color: var(--primary-color); font-family: var(--header-font);
        }
        .modal-content p, .modal-content ul { text-align: left; font-size: 1.2rem; line-height: 1.6; color: var(--text-color-dark); }
        .modal-btn {
            width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: 600;
            border: none; border-radius: 0.75rem; cursor: pointer; color: #fff;
            background-color: var(--primary-color); transition: transform 0.2s;
            margin-top: 1.5rem; font-family: var(--header-font);
        }
        .modal-btn:hover { transform: scale(1.02); }

        #activity-intro-overlay .modal-content, #instructions-modal-overlay .modal-content { border-top: 8px solid var(--primary-color); }
        #hint-modal-overlay .modal-content { border-top: 8px solid var(--secondary-color); }
        
        #hint-modal-overlay h2 { color: var(--secondary-color); }
        #hint-modal-overlay .modal-btn { background-color: var(--secondary-color); }
        #intro-text p{
            background: #f8f9fa; padding: 1.5rem; border-radius: 0.75rem; border-left: 4px solid var(--primary-color); text-align: center; font-size: 1.3rem;
        }

        /* ===== SEQUENCING TASK STYLES ===== */
        #sequencing-overlay .modal-content {
            max-width: 1000px; background: #f2f0f5; width: 95%; height: 95%;
        }
        #sequencing-prompt {
            font-family: var(--header-font); color: var(--text-color-dark);
            font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; font-weight: 500;
        }
        .sequencing-container {
            display: flex; gap: 1.5rem; width: 100%;
        }
        #drop-zones-container {
            flex: 1.2; display: flex; flex-direction: column; gap: 0.75rem;
            background: var(--drop-zone-bg); padding: 1rem; border-radius: var(--border-radius);
            border: 2px dashed #ccc;
            /* Make the drop zones scrollable when content overflows */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
            max-height: 60vh; /* Prevent growing taller than viewport; adjust as needed */
        }
        .drop-zone {
            display: flex; align-items: center;
            background: #fff; border-radius: 0.75rem; min-height: 4rem;
            border: 2px solid #ddd; padding: 0.5rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s, border-color 0.2s;
        }
        .drop-zone.drag-over {
            background: #e0f0ff;
            border-color: var(--primary-color);
        }
        .drop-zone-number {
            font-size: 1.2rem; font-weight: 700; color: var(--primary-color);
            background: #f0e6fb; border-radius: 50%;
            width: 2.5rem; height: 2.5rem;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-right: 0.75rem;
        }
        .drop-zone .draggable-item {
            margin: 0.25rem 0;
            flex-grow: 1;
        }
        #draggable-items-container {
            flex: 1; display: flex; flex-direction: column; gap: 0.75rem;
            background: #fff; padding: 1rem; border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .draggable-item {
            background: #fff; border: 2px solid #ddd; border-radius: 0.75rem;
            padding: 1rem 1.2rem; cursor: grab; transition: all 0.3s ease;
            font-size: 1.1rem; color: var(--text-color-dark); font-weight: 700;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); text-align: left;
            user-select: none;
        }
        .draggable-item:hover {
            transform: translateY(-2px); border-color: var(--primary-color);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .draggable-item.dragging {
            opacity: 0.5;
            background: #cceeff;
            cursor: grabbing;
        }

        /* Feedback Modals */
        .feedback-header { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; }
        .feedback-header h2 { font-size: 2rem; font-weight: 700; margin: 0; }
        .feedback-header.correct,   .feedback-header.correct h2{ color: var(--correct-color) !important; }
        .feedback-header.incorrect,  .feedback-header.incorrect h2 { color: var(--incorrect-color) !important; }

        .feedback-btn.correct { background-color: var(--correct-color); }
        .feedback-btn.incorrect { background-color: var(--incorrect-color); }
        #feedback-correct-overlay .modal-content { border-top: 8px solid var(--correct-color); }
        #feedback-incorrect-overlay .modal-content { border-top: 8px solid var(--incorrect-color); }
        #feedback-hint-text {
            font-style: italic;
            background: #fff8e1;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border-left: 4px solid var(--secondary-color);
            text-align: left;
        }
        
        /* ===== COMPLETION SCREEN ===== */
        #completion-overlay { 
            background-image: url('images/gamebg.jpg'); background-size: cover; background-position: center;
        }
        .completion-title-banner { 
             font-size: clamp(2rem, 7vmin, 4rem);
            text-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.2);
            text-align: center; font-family: var(--header-font);
            font-weight: 500; color: white;
        }
        #completion-overlay .modal {
            background: transparent; box-shadow: none; width: auto; max-width: none;
            display: flex; justify-content: center; align-items: center;
            padding: 0; overflow: visible;
        }
        #completion-image { 
            width: clamp(400px, 70%, 700px); max-width: 85%; height: auto;
            border: 3px solid #FBB03B; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin: 1.5rem 0;
        }
         .completion-buttons {
            position: static; width: 100%; display: flex; justify-content: space-between;
            gap: 1rem; padding: 0 2rem 2rem 2rem; box-sizing: border-box;
            align-items: flex-end; margin-top: 0;
         }
        .completion-btn {
            font-family: var(--header-font); background: var(--secondary-color); color: #fff;
            font-weight: 500; 
            font-size: 1.3rem;
            border: 0.1875rem solid #fff; border-radius: 3rem; 
            padding: clamp(0.5rem, 1.5vmin, 0.75rem) clamp(1.25rem, 3vmin, 2rem);
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            text-shadow: 0 0.125rem 0 #b88b2a; text-decoration: none;
            min-width: 8.75rem; /* 140px */
        }
        .completion-btn:hover { transform: scale(1.05); }
          @keyframes glow-pulse-white {
            0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(255,255,255,0.5); transform: scale(1); }
            50% { box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 30px rgba(255,255,255,0.7); transform: scale(1.1); }
            }
        @keyframes glow-pulse { 0%, 100% { box-shadow: 0 0 10px rgba(251,176,59,0.5), 0 0 20px rgba(251,176,59,0.3); } 50% { box-shadow: 0 0 20px rgba(251,176,59,0.8), 0 0 30px rgba(251,176,59,0.5); transform: scale(1.1); } }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            #sequencing-overlay .modal-content {
                height: 80%;
            }

        }
        @media (max-width: 991px) { 
            #game-wrapper { width: 100vw !important; height: 100vh !important; border-radius: 0 !important; max-width: none !important; aspect-ratio: unset !important; box-shadow: none; }
            html { font-size: 2.9vmin; }
            .book-container {
                height: 75vh;
                max-height: 100vh;
                width: 100%;
                box-shadow: none;
            }   
            .scenario-content { padding: 1rem; }
            #panel-image {
                height: auto;
                max-width: 35vw;
            }
            #completion-image {
                max-width: 55%;
            }
            
            /* UPDATED: Removed flex-direction and order rules to keep layout consistent */
            #sequencing-overlay .modal-content { max-height: 85vh; overflow-y: auto; }
            .drop-zone { min-height: 3.5rem; }
            .draggable-item { font-size: 1rem; padding: 0.8rem 1rem; }
        }
        @media (max-width: 768px) {
            html { font-size: 3.3vmin; }
            .scenario-title { font-size: 1.8rem; }
            .book-page { padding: 1rem; }
            .scene-description{ font-size: 1.2rem; }
            #game-title { font-size: 1.2rem; }
            .top-right-controls { gap: 0.5rem; }
            #progress-container { width: 120px; }
            #sequencing-prompt { font-size: 1.2rem; }
                #completion-image {
                max-width: 66%;
            }
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="game-container">
        <div id="start-screen" class="screen">
            <h1>Career Mapping</h1>
            <button class="start-button" onclick="showGameScreen();">Start Activity</button>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-top-section">
                <h1 id="game-title">Jay and Zuri's Journey</h1>
                <div class="top-right-controls">
                    <div id="progress-container"><div id="progress-bar"></div></div>
                    <span id="progress-text">0 / 8</span>
                    <div class="instructions-icon" onclick="showInstructions()">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </div>
                </div>
            </div>

            <h2 class="scenario-title" id="scenario-title"></h2>
            
            <div class="scenario-content" id="comic-view">
                <div class="book-container" id="book-container">
                    <div class="book-page left" id="left-page">
                        <p class="scene-description" id="scene-description-text"></p>
                    </div>
                    <div class="book-page right" id="right-page">
                        <img id="panel-image" src="" alt="Panel Image">
                    </div>
                    <div id="page-turner">
                        <div class="page-content front" id="page-turner-front"></div>
                        <div class="page-content back" id="page-turner-back"></div>
                    </div>
                </div>
            </div>
            
            <div class="hint-icon hidden" id="hint-icon" onclick="showHint()">
                <svg viewBox="0 0 24 24"><path d="M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z"></path></svg>
            </div>
        </div>

        <div id="completion-overlay" class="modal-overlay hidden">
            <div>
                <h2 class="completion-title-banner">Activity Conclusion</h2>
                  <div class="modal">
                <img id="completion-image" src="images/complete.jpg" alt="Completion celebration" onerror="this.src='https://placehold.co/400x300/7c3aed/ffffff?text=Complete!'; this.onerror=null;">
            </div>
                <div class="completion-buttons">
                    <button class="completion-btn" onclick="restartGame()">Restart Activity</button>
                    <button class="completion-btn" onclick="goToNextActivity()">Next Activity</button>
                </div>
            </div>
        </div>

        <div id="sequencing-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 id="sequencing-prompt"></h3>
                <div class="sequencing-container">
                    <div id="drop-zones-container">
                        </div>
                    <div id="draggable-items-container">
                        </div>
                </div>
                <button id="check-sequence-btn" class="modal-btn" onclick="checkSequence()">Check Answer</button>
            </div>
        </div>

        <div id="activity-intro-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Activity Introduction</h2>
                <div id="intro-text"></div>
                <button class="modal-btn" onclick="closeModal('activity-intro-overlay')">Continue</button>
            </div>
        </div>
        <div id="instructions-modal-overlay" class="modal-overlay hidden">
             <div class="modal-content">
                <h2>Learner Instructions</h2>
                <div id="instructions-text"></div>
                <button class="modal-btn" onclick="closeModal('instructions-modal-overlay')">Got it!</button>
            </div>
        </div>
        <div id="hint-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Here's a hint...</h2>
                <ul id="hint-list" style="list-style: none; padding: 0;">
                    </ul>
                <button class="modal-btn" onclick="closeModal('hint-modal-overlay')">Got it!</button>
            </div>
        </div>

        <div id="feedback-correct-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="feedback-header correct">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:2rem;height:2rem;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    <h2>Perfect Sequencing!</h2>
                </div>
                <p id="correct-feedback-text"></p>
                <button class="modal-btn feedback-btn correct" onclick="endActivity()">Continue</button>
            </div>
        </div>
        <div id="feedback-incorrect-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="feedback-header incorrect">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:2rem;height:2rem;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                    <h2>Not Quite...</h2>
                </div>
                <p id="incorrect-feedback-text"></p>
                <button class="modal-btn feedback-btn incorrect" onclick="closeModal('feedback-incorrect-overlay')">Try Again</button>
            </div>
        </div>

    </div>
</div>

<script>
    const activityData = {
        title: "Understanding Pre-Career Mapping",
        introduction: "<p>You are about to follow the story of two students, Jay and Zuri, as they plan their futures. As you watch or read, pay close attention to the decisions they make. Then, you will help them byputting their steps in the correct order, just like building your own career roadmap!</p>",
        instructions: `
            <ul>
                <li>Follow the story of Jay and Zuri as they explore and plan their future careers.</li>
                <li>When the story ends, you will see the key steps they went through, but they’ll be out of order.</li>
                <li>Drag and drop the steps from the right into the empty slots on the left, in the order that makes the most sense.</li>
                <li>If you place something in the wrong spot, you will get feedback and a hint to help you rethink.</li>
            </ul>`,
        hints: [
            "Imagine you are building your own roadmap: start with self-discovery, then gather information, make decisions, and keep checking your progress.",
            "Start with what you are naturally drawn to (your interests). Then explore how those interests connect to possible careers."
        ],
        conclusion: "Amazing work! You have just walked through Jay and Zuri’s pre-career mapping journey. Planning your future is not about guessing, it’s about exploring, learning, and choosing your own path, step by step.",
        storyScenes: [
            { scene: "Meet Jay", text: "Jay loves designing things and often sketches inventions. But he doesn’t know what career fits his interests.", image: "images/panel1.jpg" },
            { scene: "Meet Zuri", text: "Zuri enjoys helping people and is curious about health careers. She decides to ask her science teacher for advice.", image: "images/panel2.jpg" },
            { scene: "Exploration", text: "After talking to adults and exploring online, they both discover exciting careers that match their passions: engineering and nursing.", image: "images/panel3.jpg" },
            { scene: "Setting Goals", text: "They set goals: to become an aeronautical engineer and a paediatric nurse.", image: "images/panel4.jpg" },
            { scene: "Planning", text: "They review subject options, selecting math, science, and computer studies to align with their goals.", image: "images/panel5.jpg" },
            { scene: "Taking Action", text: "Jay joins a STEM club. Zuri connects with a health mentor at the local hospital.", image: "images/panel6.jpg" },
            { scene: "Reflection", text: "Months later, they pause to reflect: Are they still excited? Are their plans working? What can they adjust?", image: "images/panel7.jpg" } // Changed to panel7.jpg
        ],
        sequencingTask: {
            prompt: "Drag Jay and Zuri's career journey in the correct order",
            items: [ // These will be shuffled
                "Identify your interests",
                "Seek information on careers",
                "Set goals",
                "Academic planning (subject selection)",
                "Mentorship support",
                "Evaluate progress"
            ],
            correctSequence: [ // This is the correct order
                "Identify your interests",
                "Seek information on careers",
                "Set goals",
                "Academic planning (subject selection)",
                "Mentorship support",
                "Evaluate progress"
            ],
            feedback: {
                correct: "Perfect sequencing! You followed Jay and Zuri’s journey just right. That’s how pre-career mapping works, from knowing yourself to making smart choices for the future!",
                incorrect: "Hmm… that doesn’t seem quite right. What usually comes first: knowing what you like, or picking subjects? Let's try again.",
                hint: "Start with what you are naturally drawn to, your interests. Then explore how those interests connect to possible careers."
            }
        }
    };

    let currentSceneIndex = 0;
    const totalScenes = activityData.storyScenes.length;
    const totalSteps = totalScenes + 1; // +1 for the sequencing task
    let introAudio, dingAudio, outroAudio, pageTurnAudio, buzzAudio;
    let isTurningPage = false;
    let hintUsed = false;
    let draggedItem = null;
    let currentDropTarget = null; // For touch drag tracking
    
    // --- NEW: Variables for touch drag "ghost" ---
    let touchOffsetX = 0;
    let touchOffsetY = 0;
    // --- END NEW ---

    // Shuffle function using Fisher-Yates algorithm
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            // FIXED TYPO: shuffle+d[i] -> shuffled[i]
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function initAudio() {
        try {
            introAudio = new Audio('audio/intro.mp3');
            dingAudio = new Audio('audio/ding.mp3');
            outroAudio = new Audio('audio/outro.mp3');
            pageTurnAudio = new Audio('audio/page-flip.mp3');
            buzzAudio = new Audio('audio/buzz.mp3');
        } catch (e) {
            console.warn("Audio could not be loaded.");
            const mockAudio = { play: () => {}, pause: () => {}, currentTime: 0 };
            introAudio = dingAudio = outroAudio = pageTurnAudio = mockAudio;
            buzzAudio = mockAudio;
        }
    }

    function playSound(audio) { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); } }
    function stopSound(audio) { if(audio) { audio.pause(); } }

    function initGame() {
        loadScene(0);
    }
    
    function loadScene(index, isInstant = true) {
        currentSceneIndex = index;
        const scene = activityData.storyScenes[index];
        
        const leftPage = document.getElementById('left-page');
        const rightPage = document.getElementById('right-page');
        const descText = document.getElementById('scene-description-text');
        const panelImage = document.getElementById('panel-image');

        if (!isInstant) {
            leftPage.style.opacity = 0;
            rightPage.style.opacity = 0;
        }

        setTimeout(() => {
            document.getElementById('scenario-title').textContent = scene.scene;
            descText.innerHTML = scene.text;
            panelImage.src = scene.image;
            panelImage.alt = scene.scene;
            panelImage.onclick = () => goToNextScene(); // Click image to advance
            
            if (!isInstant) {
                leftPage.style.opacity = 1;
                rightPage.style.opacity = 1;
            }
        }, isInstant ? 0 : 300);

        updateProgress();
    }
    
    function goToNextScene() {
        if (isTurningPage) return;
        
        if (currentSceneIndex >= totalScenes - 1) {
            startSequencingTask();
            return;
        }

        isTurningPage = true;
        const pageTurner = document.getElementById('page-turner');
        const pageTurnerFront = document.getElementById('page-turner-front');
        const pageTurnerBack = document.getElementById('page-turner-back');
        
        const currentScene = activityData.storyScenes[currentSceneIndex];
        const nextScene = activityData.storyScenes[currentSceneIndex + 1];

        pageTurnerFront.innerHTML = `<img src="${currentScene.image}" alt="${currentScene.scene}" style="width: 100%; height: 100%; object-fit: contain; border-radius: var(--border-radius);">`;
        pageTurnerBack.innerHTML = `<p class="scene-description">${nextScene.text}</p>`;
        
        document.getElementById('scene-description-text').innerHTML = nextScene.text;
        
        playSound(pageTurnAudio);
        pageTurner.classList.add('turning-next');

        pageTurner.onanimationend = () => {
            const newIndex = currentSceneIndex + 1;
            loadScene(newIndex, true); 
            
            pageTurner.classList.remove('turning-next');
            pageTurner.onanimationend = null;
            isTurningPage = false;
        };
    }

    function startSequencingTask() {
        document.getElementById('sequencing-overlay').classList.remove('hidden');
        // Show hint icon only for sequencing task
        document.getElementById('hint-icon').classList.remove('hidden');
        loadSequencingTask();
        updateProgress(); // Update progress to the final step
    }
    
    function loadSequencingTask() {
        document.getElementById('sequencing-prompt').textContent = activityData.sequencingTask.prompt;
        const dropContainer = document.getElementById('drop-zones-container');
        const dragContainer = document.getElementById('draggable-items-container');
        
        dropContainer.innerHTML = '';
        dragContainer.innerHTML = '';
        
        const shuffledItems = shuffleArray(activityData.sequencingTask.items);
        
        // Create drop zones
        activityData.sequencingTask.correctSequence.forEach((_, index) => {
            const dropZone = document.createElement('div');
            dropZone.className = 'drop-zone';
            dropZone.dataset.index = index;
            dropZone.innerHTML = `<span class="drop-zone-number">${index + 1}</span>`;
            
            dropZone.addEventListener('dragover', onDragOver);
            dropZone.addEventListener('dragenter', onDragEnter);
            dropZone.addEventListener('dragleave', onDragLeave);
            dropZone.addEventListener('drop', onDrop);
            
            dropContainer.appendChild(dropZone);
        });

        // Create draggable items
        shuffledItems.forEach(itemText => {
            const item = document.createElement('div');
            item.className = 'draggable-item';
            item.textContent = itemText;
            item.draggable = true;
            item.dataset.text = itemText;
            
            item.addEventListener('dragstart', onDragStart);
            item.addEventListener('dragend', onDragEnd);
            
            // Add touch support
            item.addEventListener('touchstart', onTouchStart, { passive: false });
            
            dragContainer.appendChild(item);
        });
        
        // Add drop listeners to the original container to allow dropping back
        dragContainer.addEventListener('dragover', onDragOver);
        dragContainer.addEventListener('dragenter', onDragEnter);
        dragContainer.addEventListener('dragleave', onDragLeave);
        dragContainer.addEventListener('drop', onDrop);
    }

    // --- Drag and Drop Handlers ---

    // --- UPDATED Touch Handlers ---
    function onTouchStart(e) {
        if (!e.target.classList.contains('draggable-item')) return;
        
        e.preventDefault(); 
        
        draggedItem = this;
        // Apply dragging class to original item
        draggedItem.classList.add('dragging');

        // --- GHOST ELEMENT CREATION ---
        const rect = draggedItem.getBoundingClientRect();
        const touch = e.touches[0];

        // Calculate offset of touch within the element
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;

        // Create the ghost element
        const ghost = draggedItem.cloneNode(true);
        ghost.id = 'drag-ghost'; // Give it an ID to find it later
        ghost.style.position = 'absolute';
        ghost.style.zIndex = '9999';
        ghost.style.pointerEvents = 'none'; // Makes elementFromPoint work correctly
        ghost.style.opacity = '0.8'; // Make it look like a ghost
        ghost.style.width = rect.width + 'px';
        ghost.style.height = rect.height + 'px';
        ghost.style.boxSizing = 'border-box';
        // Position ghost relative to viewport, adjusted by offset
        ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
        ghost.style.top = (touch.clientY - touchOffsetY) + 'px';
        
        document.body.appendChild(ghost);
        // --- END GHOST LOGIC ---
        
        // Add move/end listeners
        document.addEventListener('touchmove', onTouchMove, { passive: false });
        document.addEventListener('touchend', onTouchEnd);
        document.addEventListener('touchcancel', onTouchEnd); // Also handle cancel
    }

    function onTouchMove(e) {
        if (!draggedItem) return;

        // Prevent scrolling while dragging
        e.preventDefault(); 

        const touch = e.touches[0];

        // --- MOVE GHOST ELEMENT ---
        const ghost = document.getElementById('drag-ghost');
        if (ghost) {
            ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
            ghost.style.top = (touch.clientY - touchOffsetY) + 'px';
        }
        // --- END GHOST LOGIC ---
        
        // Find element under finger. 
        // No need to hide anything since the ghost has pointer-events: none.
        const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);

        if (!elementUnder) {
            // Left the screen
            if (currentDropTarget) {
                currentDropTarget.classList.remove('drag-over');
                currentDropTarget = null;
            }
            return;
        }

        // Find the nearest valid drop target
        let dropTarget = null;
        if (elementUnder.classList.contains('drop-zone')) {
            dropTarget = elementUnder;
        } else if (elementUnder.closest('.drop-zone')) {
            dropTarget = elementUnder.closest('.drop-zone');
        } else if (elementUnder.id === 'draggable-items-container') {
            dropTarget = elementUnder;
        } else if (elementUnder.closest('#draggable-items-container')) {
            dropTarget = elementUnder.closest('#draggable-items-container');
        }

        // Handle entering/leaving drop targets
        if (currentDropTarget && currentDropTarget !== dropTarget) {
            // We left the previous target
            currentDropTarget.classList.remove('drag-over');
        }

        if (dropTarget && dropTarget !== currentDropTarget) {
            // We entered a new target
            dropTarget.classList.add('drag-over');
        }
        
        currentDropTarget = dropTarget;
    }

    function onTouchEnd(e) {
        if (!draggedItem) return;

        // --- REMOVE GHOST ELEMENT ---
        const ghost = document.getElementById('drag-ghost');
        if (ghost) ghost.remove();
        touchOffsetX = 0; // Reset offsets
        touchOffsetY = 0;
        // --- END GHOST LOGIC ---

        // Remove document listeners
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onTouchEnd);
        document.removeEventListener('touchcancel', onTouchEnd);

        if (currentDropTarget) {
            // Simulate the drop
            onDrop.call(currentDropTarget, e); // 'this' context will be currentDropTarget
        }
        
        // Clean up
        if(currentDropTarget) {
            currentDropTarget.classList.remove('drag-over');
        }
        // Remove dragging class from original item
        draggedItem.classList.remove('dragging');
        draggedItem = null;
        currentDropTarget = null;
    }
    // --- End of UPDATED Touch Handlers ---


    // --- Original Mouse Handlers (unchanged) ---
    function onDragStart(e) {
        draggedItem = this;
        setTimeout(() => this.classList.add('dragging'), 0);
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function onDragEnd() {
        this.classList.remove('dragging');
        draggedItem = null;
    }
    
    function onDragOver(e) {
        e.preventDefault();
    }

    function onDragEnter(e) {
        e.preventDefault();
        if (this.classList.contains('drop-zone') || this.id === 'draggable-items-container') {
            this.classList.add('drag-over');
        }
    }
    
    function onDragLeave() {
        this.classList.remove('drag-over');
    }
    
    // --- Unified Drop Handler (for both mouse and touch) ---
    function onDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        if (draggedItem && (this.classList.contains('drop-zone') || this.id === 'draggable-items-container')) {
            // If dropping in a drop-zone that already has an item, swap them
            if (this.classList.contains('drop-zone') && this.children.length > 1) {
                const existingItem = this.querySelector('.draggable-item');
                const originContainer = draggedItem.parentElement.id === 'draggable-items-container' 
                    ? document.getElementById('draggable-items-container') 
                    : draggedItem.parentElement;
                
                originContainer.appendChild(existingItem);
            }
            this.appendChild(draggedItem);
        }
    }
    
    function checkSequence() {
        const dropZones = document.querySelectorAll('#drop-zones-container .drop-zone');
        let userSequence = [];
        
        dropZones.forEach(zone => {
            const item = zone.querySelector('.draggable-item');
            if (item) {
                userSequence.push(item.dataset.text);
            } else {
                userSequence.push(null); // Mark empty slots
            }
        });
        
        const isCorrect = JSON.stringify(userSequence) === JSON.stringify(activityData.sequencingTask.correctSequence);
        
        if (isCorrect) {
            playSound(dingAudio);
            showFeedbackPopup('correct', activityData.sequencingTask.feedback.correct);
        } else {
            playSound(buzzAudio);
            // Removed hint logic from here
            showFeedbackPopup('incorrect', activityData.sequencingTask.feedback.incorrect);
        }
    }

    function showFeedbackPopup(type, message) {
        document.getElementById(`${type}-feedback-text`).innerHTML = message;
        document.getElementById(`feedback-${type}-overlay`).classList.remove('hidden');
    }
    
    function updateProgress() {
        const isSequencing = !document.getElementById('sequencing-overlay').classList.contains('hidden');
        let currentStep;
        
        if (isSequencing) {
            currentStep = totalSteps;
        } else {
            currentStep = currentSceneIndex + 1;
        }
        
        document.getElementById('progress-bar').style.width = `${(currentStep / totalSteps) * 100}%`;
        document.getElementById('progress-text').textContent = `${currentStep} / ${totalSteps}`;
    }
    
    function showGameScreen() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        showActivityIntro();
    }
    
    function showActivityIntro() {
        document.getElementById('activity-intro-overlay').classList.remove('hidden');
        playSound(introAudio);
        sendEvent('ActivityEvent.START_ACTIVITY', {activityName: activityData.title});
    }

    function showInstructions() { document.getElementById('instructions-modal-overlay').classList.remove('hidden'); }
    function showHint() { document.getElementById('hint-modal-overlay').classList.remove('hidden'); }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
        if (id === 'activity-intro-overlay') { 
            stopSound(introAudio); 
            initGame(); 
        }
    }
    
    function endActivity() {
        closeModal('feedback-correct-overlay');
        document.getElementById('sequencing-overlay').classList.add('hidden');
        document.getElementById('completion-overlay').classList.remove('hidden');
        document.getElementById('completion-image').alt = activityData.conclusion;
        // Hide hint icon on completion
        document.getElementById('hint-icon').classList.add('hidden');
        playSound(outroAudio);
    }
    
    function restartGame() {
        stopSound(outroAudio);
        document.getElementById('completion-overlay').classList.add('hidden');
        document.getElementById('sequencing-overlay').classList.add('hidden');
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        // Hide hint icon on restart
        document.getElementById('hint-icon').classList.add('hidden');
        
        currentSceneIndex = 0;
        hintUsed = false;

        initGame();
    }

    function goToNextActivity() { 
        window.location.href = "../ACTIVITY2/index.html"; // Assuming next activity is in this path
        stopSound(outroAudio);
        sendEvent('ActivityEvent.END_ACTIVITY', {activityName: activityData.title});

    }
    
    function populateStaticContent() {
        document.getElementById('game-title').textContent = activityData.title;
        document.getElementById('intro-text').innerHTML = activityData.introduction;
        document.getElementById('instructions-text').innerHTML = activityData.instructions;
        
        const hintList = document.getElementById('hint-list');
        // FIXED TYPO: activityaData -> activityData
        // UPDATED: Populate with the specific sequencing hint, as the icon is only visible during that task
        hintList.innerHTML = `<li>${activityData.sequencingTask.feedback.hint}</li>`;

        document.getElementById('progress-text').textContent = `1 / ${totalSteps}`;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        initAudio();
        populateStaticContent();
    });
    
</script>
<script src = "../eventSender.js"></script>
</body>
</html>